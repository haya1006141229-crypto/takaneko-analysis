<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>たかねこ 楽曲分析 Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    :root {
      --pink:#f472b6; --pink-light:#fce7f3; --pink-dark:#db2777; --pink-soft:#fbcfe8;
      --gold:#d4af37; --gold-light:#fef9e7;
      --bg:#fff5f9; --surface:#ffffff; --text:#3d2b35; --text-muted:#9d6b8a;
      --border:#fad4e8; --radius:20px;
      --shadow:0 4px 24px rgba(244,114,182,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{max-width:100%;overflow-x:hidden;}
    body{font-family:'Zen Maru Gothic',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;
      background-image:radial-gradient(circle at 20% 20%,rgba(244,114,182,0.08) 0%,transparent 50%),
      radial-gradient(circle at 80% 80%,rgba(212,175,55,0.06) 0%,transparent 50%);}

    /* HEADER */
    header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(244,114,182,0.08);}
    .header-inner{max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px;gap:10px;}
    .logo{display:flex;flex-direction:column;line-height:1.2;flex-shrink:0;}
    .logo-sub{font-size:9px;letter-spacing:2px;color:var(--gold);font-family:'DM Mono',monospace;text-transform:uppercase;}
    .logo-main{font-size:15px;font-weight:700;color:var(--pink-dark);}
    nav{display:flex;gap:4px;flex-shrink:0;}
    .nav-btn{padding:7px 13px;border:1.5px solid var(--border);background:transparent;color:var(--text-muted);border-radius:50px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;font-size:12px;font-weight:500;transition:all .2s;white-space:nowrap;}
    .nav-btn:hover{border-color:var(--pink);color:var(--pink);background:var(--pink-light);}
    .nav-btn.active{background:var(--pink);border-color:var(--pink);color:#fff;box-shadow:0 2px 12px rgba(244,114,182,0.3);}
    .official-links{display:flex;gap:5px;flex-shrink:0;}
    .link-btn{padding:5px 10px;border-radius:50px;text-decoration:none;font-size:10px;font-weight:700;color:#fff;transition:all .2s;white-space:nowrap;}
    .link-btn:hover{transform:translateY(-2px);opacity:.85;}
    .link-web{background:var(--pink);} .link-x{background:#000;} .link-yt{background:#f00;} .link-fc{background:var(--gold);}

    /* MAIN */
    main{max-width:1280px;margin:0 auto;padding:22px 18px;}
    .tab-content{display:none;animation:fadeUp .3s ease;}
    .tab-content.active{display:block;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* CARDS */
    .card{background:var(--surface);border-radius:var(--radius);padding:18px;border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:16px;}
    .card-title{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--gold);font-family:'DM Mono',monospace;text-transform:uppercase;margin-bottom:12px;}
    .chart-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);padding:18px;margin-bottom:16px;position:relative;min-height:380px;}
    .chart-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;flex-wrap:wrap;gap:8px;}
    .chart-title{font-size:15px;font-weight:700;color:var(--text);}
    .chart-subtitle{font-size:11px;color:var(--text-muted);margin-top:2px;}
    .chart-wrap{position:relative;height:380px;}

    /* CONTROLS */
    .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:10px;align-items:end;}
    .field{display:flex;flex-direction:column;gap:4px;}
    .field label{font-size:11px;font-weight:700;color:var(--pink-dark);}
    select,input[type=date],input[type=month]{padding:8px 30px 8px 11px;border:1.5px solid var(--border);border-radius:11px;font-family:'Zen Maru Gothic',sans-serif;font-size:13px;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s;width:100%;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239d6b8a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;}
    input[type=date],input[type=month]{background-image:none;padding-right:11px;}
    select:focus,input:focus{border-color:var(--pink);box-shadow:0 0 0 3px rgba(244,114,182,0.1);}
    .btn-row{display:flex;gap:8px;align-items:center;padding-top:2px;}
    .btn{padding:9px 16px;border-radius:50px;border:none;font-family:'Zen Maru Gothic',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
    .btn-primary{background:var(--pink);color:#fff;flex:1;box-shadow:0 2px 12px rgba(244,114,182,0.25);}
    .btn-primary:hover{background:var(--pink-dark);transform:translateY(-2px);}
    .btn-secondary{background:#f3f4f6;color:#888;}
    .btn-secondary:hover{background:#e5e7eb;}
    .btn-gold{background:var(--gold);color:#fff;box-shadow:0 2px 12px rgba(212,175,55,0.25);}
    .btn-gold:hover{transform:translateY(-2px);opacity:.9;}
    .notice{background:var(--pink-light);border-left:3px solid var(--pink);padding:8px 12px;border-radius:8px;font-size:11px;color:var(--pink-dark);margin-top:10px;line-height:1.6;}

    /* ZOOM HINT */
    .zoom-hint{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--text-muted);background:var(--pink-light);padding:3px 9px;border-radius:20px;font-family:'DM Mono',monospace;}
    .zoom-reset-btn{padding:3px 9px;border-radius:20px;border:1.5px solid var(--border);background:var(--surface);color:var(--text-muted);font-size:11px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;font-weight:700;transition:all .2s;}
    .zoom-reset-btn:hover{border-color:var(--pink);color:var(--pink);}

    /* EMPTY STATE */
    .empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-muted);gap:12px;}
    .empty-icon{font-size:48px;opacity:.4;} .empty-text{font-size:14px;}

    /* STATS PILLS */
    .stats-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
    .stat-pill{background:var(--surface);border:1px solid var(--border);border-radius:50px;padding:6px 14px;display:flex;align-items:center;gap:7px;box-shadow:var(--shadow);}
    .stat-label{font-size:10px;color:var(--text-muted);}
    .stat-val{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--pink-dark);}

    /* RANKING */
    .ranking-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:7px;}
    .ranking-item{display:flex;align-items:center;gap:11px;padding:11px 13px;background:var(--surface);border:1px solid var(--border);border-radius:13px;transition:all .2s;cursor:pointer;}
    .ranking-item:hover{border-color:var(--pink);box-shadow:var(--shadow);transform:translateY(-2px);}
    .rank-num{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--pink-soft);width:28px;flex-shrink:0;text-align:center;}
    .rank-num.top1{color:var(--gold);font-size:20px;} .rank-num.top2{color:#b0b0b0;font-size:18px;} .rank-num.top3{color:#cd7f32;font-size:18px;}
    .rank-name{flex:1;font-size:13px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .rank-count{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;color:var(--gold);flex-shrink:0;}
    .rank-bar-wrap{width:100%;height:3px;background:var(--border);border-radius:2px;margin-top:5px;overflow:hidden;}
    .rank-bar{height:100%;background:linear-gradient(90deg,var(--pink),var(--gold));border-radius:2px;transition:width .8s cubic-bezier(.4,0,.2,1);}

    /* COMPARE */
    .compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
    .chart-half{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);padding:16px;}
    .chart-half-wrap{position:relative;height:260px;}
    .stat-badge{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 16px;box-shadow:var(--shadow);}

    /* CATEGORY BTNS */
    .cat-btn{padding:5px 11px;border:1.5px solid var(--border);border-radius:20px;background:var(--surface);color:var(--text-muted);font-family:'Zen Maru Gothic',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .18s;white-space:nowrap;}
    .cat-btn:hover{border-color:var(--pink);color:var(--pink-dark);background:var(--pink-light);}
    .cat-btn.active{background:linear-gradient(135deg,var(--pink),var(--pink-dark));border-color:var(--pink-dark);color:#fff;box-shadow:0 3px 12px rgba(244,114,182,0.35);}
    .cat-group{display:flex;gap:5px;flex-wrap:wrap;}

    /* YEAR CHECKBOX */
    .year-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;display:inline-block;}
    .year-check-label{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:700;color:var(--text-muted);cursor:pointer;padding:5px 10px;border:1.5px solid var(--border);border-radius:20px;transition:all .15s;user-select:none;}
    .year-check-label:hover{border-color:var(--pink);color:var(--pink-dark);background:var(--pink-light);}
    .year-check-label input[type=checkbox]{width:14px;height:14px;accent-color:var(--pink);cursor:pointer;}
    .year-check-label:has(input:checked){border-color:var(--pink-dark);background:var(--pink-light);color:var(--pink-dark);}

    /* PREF */
    .pref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:7px;}
    .pref-card{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:11px;text-align:center;transition:all .2s;cursor:pointer;}
    .pref-card:hover{border-color:var(--pink);transform:translateY(-2px);box-shadow:var(--shadow);}
    .pref-name{font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px;}
    .pref-count{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;color:var(--pink-dark);}
    .pref-sub{font-size:9px;color:var(--text-muted);}
    .pref-top{font-size:9px;color:var(--gold);font-weight:700;margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    /* LOADING */
    .loading-overlay{position:fixed;inset:0;background:rgba(255,245,249,0.92);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;backdrop-filter:blur(4px);}
    .loading-overlay.show{display:flex;}
    .spinner{width:44px;height:44px;border:3px solid var(--pink-soft);border-top-color:var(--pink);border-radius:50%;animation:spin .8s linear infinite;}
    .loading-text{font-size:13px;color:var(--text-muted);font-family:'DM Mono',monospace;letter-spacing:2px;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* MOBILE NAV */
    .mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:7px 12px env(safe-area-inset-bottom,10px);z-index:100;gap:3px;}
    .mobile-nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 3px;border:none;background:transparent;color:var(--text-muted);font-family:'Zen Maru Gothic',sans-serif;font-size:9px;font-weight:500;cursor:pointer;border-radius:11px;transition:all .2s;}
    .mobile-nav-btn.active{color:var(--pink);background:var(--pink-light);}
    .mobile-nav-icon{font-size:18px;}

    /* DRILL MODAL */
    .drill-modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(61,43,53,0.55);backdrop-filter:blur(6px);overflow-y:auto;padding:18px 14px;}
    .drill-inner{max-width:760px;margin:0 auto;background:var(--surface);border-radius:var(--radius);box-shadow:0 20px 80px rgba(244,114,182,0.25);overflow:hidden;}
    .drill-head{background:linear-gradient(135deg,var(--pink),var(--pink-dark));padding:20px 24px;display:flex;justify-content:space-between;align-items:center;}
    .drill-close{background:rgba(255,255,255,0.2);border:none;border-radius:50%;width:34px;height:34px;cursor:pointer;font-size:17px;color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .2s;}
    .drill-close:hover{background:rgba(255,255,255,0.35);}
    .drill-body{padding:20px 24px;}

    /* RESPONSIVE */
    /* ===== MOBILE / RESPONSIVE ===== */
    @media(max-width:900px){
      .compare-grid{grid-template-columns:1fr;}
      #eventMainGrid{grid-template-columns:1fr!important;}
    }
    @media(max-width:768px){
      header{padding:0 10px;} .header-inner{height:50px;} .logo-main{font-size:13px;}
      nav{display:none;} .official-links{display:none;}
      main{padding:10px 8px 80px;overflow-x:hidden;}
      body{overflow-x:hidden;}
      .controls-grid{grid-template-columns:1fr 1fr;}
      .mobile-nav{display:flex;}
      .card{padding:12px;} .chart-card{padding:12px;min-height:280px;}
      .chart-wrap{height:260px;} .chart-half-wrap{height:200px;}
      .ranking-grid{grid-template-columns:1fr;}
      .drill-body{padding:12px;} .drill-head{padding:12px 14px;}
      .pref-grid{grid-template-columns:repeat(auto-fill,minmax(95px,1fr));}
      /* 年度比較: catボタン群を折り返し */
      .cat-group{flex-wrap:wrap;}
      /* 年選択を折り返し */
      #yearCheckboxes{gap:4px;}
      /* 公演別: スロット縦並び */
      #evPanelCompare > div:first-child{grid-template-columns:1fr!important;}
      /* ドリルモーダル */
      .drill-inner{margin:0;border-radius:16px 16px 0 0;}
      .drill-modal{padding:60px 0 0;}
      #drillYearGrid{grid-template-columns:repeat(2,1fr)!important;}
      /* モードボタン縮小 */
      .mode-btn{padding:5px 10px;font-size:11px;}
    }
    @media(max-width:480px){
      .controls-grid{grid-template-columns:1fr;}
      .cat-btn{font-size:10px;padding:4px 8px;}
      .mode-btn{padding:5px 8px;font-size:10px;}
      .stats-row{gap:4px;}
      .stat-pill{padding:5px 10px;}
    }

    /* ===== EVENT SEARCH TAB ===== */
    .event-search-box{position:relative;margin-bottom:12px;}
    .event-search-input{width:100%;padding:10px 40px 10px 14px;border:1.5px solid var(--border);border-radius:12px;font-family:'Zen Maru Gothic',sans-serif;font-size:13px;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s;}
    .event-search-input:focus{border-color:var(--pink);box-shadow:0 0 0 3px rgba(244,114,182,0.1);}
    .event-search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:16px;pointer-events:none;}
    .event-year-section{margin-bottom:10px;}
    .event-year-header{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--pink-light);border-radius:10px;cursor:pointer;user-select:none;margin-bottom:5px;}
    .event-year-label{font-size:11px;font-weight:700;color:var(--pink-dark);font-family:'DM Mono',monospace;}
    .event-year-count{font-size:10px;color:var(--text-muted);margin-left:auto;}
    .event-group-section{margin-bottom:7px;margin-left:10px;}
    .event-group-header{display:flex;align-items:center;gap:8px;padding:5px 10px;background:var(--bg);border:1px solid var(--border);border-radius:9px;cursor:pointer;user-select:none;margin-bottom:3px;}
    .event-group-label{font-size:12px;font-weight:700;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .event-group-count{font-size:10px;color:var(--text-muted);flex-shrink:0;}
    .event-group-toggle{font-size:10px;color:var(--text-muted);flex-shrink:0;transition:transform .2s;}
    .event-items{display:none;flex-direction:column;gap:2px;margin-left:10px;margin-bottom:4px;}
    .event-items.open{display:flex;}
    .event-item{display:flex;align-items:center;gap:8px;padding:5px 10px;border-radius:8px;cursor:pointer;transition:background .15s;}
    .event-item:hover{background:var(--pink-light);}
    .event-item input[type=checkbox]{width:14px;height:14px;accent-color:var(--pink);cursor:pointer;flex-shrink:0;}
    .event-item-name{font-size:11px;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .event-item-date{font-size:10px;color:var(--text-muted);flex-shrink:0;font-family:'DM Mono',monospace;}
    .selected-tags{display:flex;flex-wrap:wrap;gap:5px;min-height:24px;margin-bottom:10px;}
    .sel-tag{display:flex;align-items:center;gap:4px;padding:3px 10px;background:var(--pink);color:#fff;border-radius:20px;font-size:11px;font-weight:700;}
    .sel-tag-x{cursor:pointer;font-size:12px;opacity:.8;transition:opacity .15s;background:none;border:none;color:#fff;padding:0;}
    .sel-tag-x:hover{opacity:1;}
    .ev-compare-panel{display:none;margin-top:10px;}
    .ev-slot{background:var(--surface);border:2px dashed var(--border);border-radius:14px;padding:14px;margin-bottom:10px;}
    .ev-slot.has-data{border-style:solid;border-color:var(--pink);}
    .ev-slot-label{font-size:11px;font-weight:700;color:var(--gold);font-family:'DM Mono',monospace;text-transform:uppercase;margin-bottom:8px;}
    .ev-slot-tags{display:flex;flex-wrap:wrap;gap:5px;min-height:22px;}

    /* ===== 楽曲分析・モードボタン ===== */
    .mode-btn{padding:7px 14px;border:1.5px solid var(--border);background:transparent;color:var(--text-muted);border-radius:50px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;font-size:12px;font-weight:700;transition:all .2s;white-space:nowrap;}
    .mode-btn:hover{border-color:var(--pink);color:var(--pink);background:var(--pink-light);}
    .mode-btn.active{background:var(--pink);border-color:var(--pink);color:#fff;box-shadow:0 2px 10px rgba(244,114,182,0.3);}

    /* ===== セトリ表示 ===== */
    .setlist-song{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--bg);border-radius:10px;border-left:3px solid transparent;transition:all .15s;}
    .setlist-song.is-first{border-left-color:var(--gold);}
    .setlist-song.is-last{border-left-color:var(--pink);}
    .setlist-num{font-family:'DM Mono',monospace;font-size:11px;color:var(--text-muted);width:22px;flex-shrink:0;text-align:right;}
    .setlist-name{flex:1;font-size:13px;font-weight:600;color:var(--text);}
    .setlist-tag{font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;flex-shrink:0;}
    .setlist-tag.first{background:var(--gold-light);color:var(--gold);}
    .setlist-tag.last{background:var(--pink-light);color:var(--pink-dark);}

    /* ===== 楽曲サマリー ===== */
    .song-sum-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow);}
    .song-sum-label{font-size:10px;color:var(--text-muted);font-family:'DM Mono',monospace;letter-spacing:1px;margin-bottom:5px;}
    .song-sum-val{font-size:20px;font-weight:700;color:var(--pink-dark);}
    .song-sum-sub{font-size:10px;color:var(--text-muted);margin-top:2px;}

    /* ===== モバイル公演パネル ===== */
    @media(max-width:900px){
      #eventMainGrid{grid-template-columns:1fr!important;}
    }

    /* ===== 公演別モバイル専用UI ===== */
    @media(max-width:768px){
      /* 公演リストカードの高さを制限（スクロール可） */
      #eventMainGrid > .card:first-child{max-height:320px!important;}

      /* 右パネルをボトムドロワーとして表示 */
      #evRightPanel{
        position:fixed;
        left:0;right:0;bottom:0;
        background:var(--surface);
        border-radius:20px 20px 0 0;
        box-shadow:0 -4px 30px rgba(0,0,0,0.15);
        z-index:200;
        max-height:75vh;
        overflow-y:auto;
        padding:0 0 env(safe-area-inset-bottom,16px);
        transform:translateY(100%);
        transition:transform 0.3s cubic-bezier(0.32,0.72,0,1);
      }
      #evRightPanel.drawer-open{
        transform:translateY(0);
      }
      /* ドロワー上部のハンドル */
      #evRightPanel::before{
        content:'';
        display:block;
        width:40px;height:4px;
        background:var(--border);
        border-radius:2px;
        margin:12px auto 8px;
      }
      /* ドロワー内のパディング */
      #evRightPanel > div{padding:0 12px 12px;}
      /* ドロワーオーバーレイ */
      #evDrawerOverlay{
        display:none;
        position:fixed;inset:0;
        background:rgba(0,0,0,0.3);
        z-index:199;
      }
      #evDrawerOverlay.active{display:block;}
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">
      <span class="logo-sub">Advanced Performance Analysis</span>
      <span class="logo-main">たかねこ 楽曲分析 Portal</span>
    </div>
    <nav>
      <button class="nav-btn active" onclick="switchTab('analyze')">🎵 楽曲分析</button>
      <button class="nav-btn" onclick="switchTab('compare')">📈 年度比較</button>
      <button class="nav-btn" onclick="switchTab('event')">🎤 公演別</button>
      <button class="nav-btn" onclick="switchTab('pref')">🗾 都道府県</button>
    </nav>
    <div class="official-links">
      <a href="https://takanenonadeshiko.jp/" target="_blank" class="link-btn link-web">公式</a>
      <a href="https://x.com/takanenofficial" target="_blank" class="link-btn link-x">X</a>
      <a href="https://www.youtube.com/channel/UCoR4zZDvWvUIqgEWz4HS-sA" target="_blank" class="link-btn link-yt">YT</a>
      <a href="https://takanekofc.com/#/" target="_blank" class="link-btn link-fc">FC</a>
    </div>
  </div>
</header>

<main>

  <!-- ===== TAB: 楽曲分析 ===== -->
  <div id="tab-analyze" class="tab-content active">

    <!-- 上段コントロール -->
    <div class="card" style="margin-bottom:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">🎵 楽曲分析</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;" id="analyzeYearBtns">
          <span style="font-size:11px;color:var(--text-muted);font-weight:700;">対象年：</span>
          <label class="year-check-label"><input type="checkbox" class="an-year-cb" value="2023" onchange="onAnalyzeYearChange()"> 2023</label>
          <label class="year-check-label"><input type="checkbox" class="an-year-cb" value="2024" onchange="onAnalyzeYearChange()"> 2024</label>
          <label class="year-check-label"><input type="checkbox" class="an-year-cb" value="2025" checked onchange="onAnalyzeYearChange()"> 2025</label>
          <label class="year-check-label"><input type="checkbox" class="an-year-cb" value="2026" onchange="onAnalyzeYearChange()"> 2026</label>
        </div>
      </div>

      <!-- モード切り替え -->
      <div style="display:flex;gap:6px;margin-bottom:14px;border-bottom:1px solid var(--border);padding-bottom:12px;">
        <button class="mode-btn active" id="modeBtnCategory" onclick="setAnalyzeMode('category')">📊 カテゴリ分析</button>
        <button class="mode-btn" id="modeBtnSong" onclick="setAnalyzeMode('song')">🎵 楽曲を選んで分析</button>
      </div>

      <!-- カテゴリモード -->
      <div id="panelCategory">
        <div class="controls-grid">
          <div class="field">
            <label>分析カテゴリー</label>
            <select id="columnSelect">
              <optgroup label="基本">
                <option value="song">★ 楽曲別 歌唱回数</option>
                <option value="first">【1曲目】出現回数</option>
                <option value="last">【トリ】出現回数</option>
                <option value="combo">鉄板コンボ分析</option>
              </optgroup>
              <optgroup label="季節別">
                <option value="spring">春 (3〜5月)</option>
                <option value="summer">夏 (6〜8月)</option>
                <option value="autumn">秋 (9〜11月)</option>
                <option value="winter">冬 (12〜2月)</option>
              </optgroup>
              <optgroup label="セット規模別">
                <option value="shortFirst">少曲数(1-4曲)1曲目</option>
                <option value="longFirst">多曲数(5曲以上)1曲目</option>
              </optgroup>
              <optgroup label="✨ イベント種別">
                <option value="fesFirst">フェス/対バン限定 1曲目</option>
                <option value="fesSong">フェス/対バン限定 TOP曲</option>
                <option value="onemanFirst">ワンマン限定 1曲目</option>
                <option value="onemanSong">ワンマン限定 TOP曲</option>
                <option value="multiFirst">二部制限定 1曲目</option>
              </optgroup>
              <optgroup label="🎶 アンコール">
                <option value="encoreTop">アンコール 回数TOP</option>
                <option value="encoreRate">アンコール 率TOP</option>
              </optgroup>
            </select>
          </div>
          <div class="field">
            <label>グラフ種別</label>
            <select id="chartTypeSelect">
              <option value="horizontalBar">横棒グラフ</option>
              <option value="bar">縦棒グラフ</option>
              <option value="pie">円グラフ</option>
              <option value="doughnut">ドーナツグラフ</option>
            </select>
          </div>
          <div class="field">
            <label>期間（開始）</label>
            <input type="date" id="startDate">
          </div>
          <div class="field">
            <label>期間（終了）</label>
            <input type="date" id="endDate">
          </div>
          <div class="field">
            <label>表示件数</label>
            <select id="limitSelect">
              <option value="10">上位10件</option>
              <option value="20" selected>上位20件</option>
              <option value="30">上位30件</option>
              <option value="999">全件</option>
            </select>
          </div>
        </div>
        <div class="btn-row" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="analyze()">📊 分析を開始する</button>
          <button class="btn btn-secondary" onclick="resetFilters()">リセット</button>
        </div>
        <div class="notice">💡 グラフはドラッグで範囲ズーム・ダブルクリックでリセット。バーをクリックすると曲の詳細を表示します。複数年チェックすると年度比較も可能。</div>
      </div>

      <!-- 楽曲選択モード -->
      <div id="panelSong" style="display:none;">
        <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;">
          <div class="field" style="flex:1;min-width:200px;">
            <label>🔍 楽曲名を選択・検索</label>
            <input type="text" id="songSearchInput" placeholder="曲名を入力してください..." list="songDatalist" oninput="onSongInputChange()" style="padding:8px 12px;border:1.5px solid var(--border);border-radius:11px;font-family:inherit;font-size:13px;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s;width:100%;">
            <datalist id="songDatalist"></datalist>
          </div>
          <button class="btn btn-primary" onclick="analyzeSong()" style="flex-shrink:0;height:40px;">🎵 この曲を分析</button>
          <button class="btn btn-secondary" onclick="clearSongAnalysis()" style="flex-shrink:0;height:40px;">リセット</button>
        </div>
        <div id="songQuickPicks" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;"></div>
        <div class="notice">💡 曲名を入力するとすべての年からその曲の傾向を分析します。最終歌唱日・年別推移・出演イベント一覧が確認できます。</div>
      </div>
    </div>

    <!-- 統計バー -->
    <div class="stats-row" id="statsRow" style="display:none;">
      <div class="stat-pill"><span class="stat-label">総楽曲数</span><span class="stat-val" id="stat-songs">-</span></div>
      <div class="stat-pill"><span class="stat-label">総歌唱回数</span><span class="stat-val" id="stat-total">-</span></div>
      <div class="stat-pill"><span class="stat-label">最多楽曲</span><span class="stat-val" id="stat-top">-</span></div>
    </div>

    <!-- メイングラフ -->
    <div class="chart-card" id="mainChartCard">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="chartTitleText">分析結果</div>
          <div class="chart-subtitle" id="chartSubtitle">分析設定を選択して「分析を開始する」を押してください</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <span class="zoom-hint">🔍 ドラッグでズーム</span>
          <button class="zoom-reset-btn" onclick="resetMainZoom()">リセット</button>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="mainChart"></canvas>
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">🎵</div>
          <div class="empty-text">分析を実行すると結果が表示されます</div>
        </div>
      </div>
    </div>

    <!-- 楽曲分析詳細パネル（楽曲選択モード時に表示） -->
    <div id="songAnalysisPanel" style="display:none;">
      <!-- 楽曲サマリー -->
      <div id="songSummaryGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:14px;"></div>

      <!-- 年別推移グラフ -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title" id="songTrendTitle">年別 歌唱回数推移</div>
            <div class="chart-subtitle" id="songTrendSub"></div>
          </div>
        </div>
        <div style="position:relative;height:240px;"><canvas id="songTrendChart"></canvas></div>
      </div>

      <!-- 月別分布グラフ -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">月別 歌唱分布（全年合計）</div>
            <div class="chart-subtitle" id="songMonthSub"></div>
          </div>
        </div>
        <div style="position:relative;height:220px;"><canvas id="songMonthChart"></canvas></div>
      </div>

      <!-- 出演イベント一覧 -->
      <div class="card">
        <div class="card-title" id="songEventListTitle">📋 出演イベント一覧</div>
        <div id="songEventList" style="display:flex;flex-direction:column;gap:5px;max-height:400px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- ランキング（カテゴリモードのみ） -->
    <div id="rankingSection" style="display:none;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">🏆 ランキング一覧</div>
        <span style="font-size:11px;color:var(--text-muted);">各項目クリックで詳細</span>
      </div>
      <div class="ranking-grid" id="rankingGrid"></div>
    </div>

  </div>

  <!-- ===== TAB: 年度比較 ===== -->
  <div id="tab-compare" class="tab-content">
    <div class="card">
      <div class="card-title">📈 Year Comparison</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div style="display:flex;flex-direction:column;gap:4px;flex:1;min-width:200px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">カテゴリ</label>
          <div class="cat-group">
            <button class="cat-btn active" data-cat="song" onclick="setCompareCategory(this,'song')">🎵 全曲</button>
            <button class="cat-btn" data-cat="first" onclick="setCompareCategory(this,'first')">🎤 1曲目</button>
            <button class="cat-btn" data-cat="last" onclick="setCompareCategory(this,'last')">🎆 トリ</button>
            <button class="cat-btn" data-cat="spring" onclick="setCompareCategory(this,'spring')">🌸 春</button>
            <button class="cat-btn" data-cat="summer" onclick="setCompareCategory(this,'summer')">☀️ 夏</button>
            <button class="cat-btn" data-cat="autumn" onclick="setCompareCategory(this,'autumn')">🍂 秋</button>
            <button class="cat-btn" data-cat="winter" onclick="setCompareCategory(this,'winter')">❄️ 冬</button>
            <button class="cat-btn" data-cat="combo" onclick="setCompareCategory(this,'combo')">🔗 コンボ</button>
            <button class="cat-btn" data-cat="fesFirst" onclick="setCompareCategory(this,'fesFirst')">🎪 フェス1曲目</button>
            <button class="cat-btn" data-cat="onemanFirst" onclick="setCompareCategory(this,'onemanFirst')">🏟 ワンマン1曲目</button>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">比較対象年</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;" id="yearCheckboxes">
            <label class="year-check-label"><input type="checkbox" class="year-cb" value="2023" checked onchange="runCompare()"> 2023</label>
            <label class="year-check-label"><input type="checkbox" class="year-cb" value="2024" checked onchange="runCompare()"> 2024</label>
            <label class="year-check-label"><input type="checkbox" class="year-cb" value="2025" checked onchange="runCompare()"> 2025</label>
            <label class="year-check-label"><input type="checkbox" class="year-cb" value="2026" checked onchange="runCompare()"> 2026</label>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">表示件数</label>
          <select id="compareLimit" style="height:36px;padding:0 28px 0 10px;" onchange="runCompare()">
            <option value="10">Top 10</option><option value="15" selected>Top 15</option>
            <option value="20">Top 20</option><option value="30">Top 30</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">期間（開始）</label>
          <input type="month" id="compareStart" style="height:36px;padding:0 10px;" onchange="runCompare()">
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">期間（終了）</label>
          <input type="month" id="compareEnd" style="height:36px;padding:0 10px;" onchange="runCompare()">
        </div>
        <button class="btn btn-gold" onclick="runCompare()">🔄 分析実行</button>
        <button class="btn" style="background:var(--pink-light);color:var(--pink-dark);" onclick="resetCompare()">✕ リセット</button>
      </div>
    </div>

    <div id="compareSummary" style="display:none;margin-bottom:14px;">
      <div id="compareSummaryGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;"></div>
    </div>

    <div class="compare-grid">
      <div class="chart-half">
        <div class="chart-title" style="font-size:13px;margin-bottom:10px;">年度別 公演数</div>
        <div class="chart-half-wrap"><canvas id="eventChart"></canvas></div>
      </div>
      <div class="chart-half">
        <div class="chart-title" style="font-size:13px;margin-bottom:10px;">月別 公演数推移</div>
        <div class="chart-half-wrap"><canvas id="monthlyChart"></canvas></div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="compareChartTitle">楽曲別 年度比較</div>
          <div class="chart-subtitle" id="compareChartSub">カテゴリを選んで分析実行してください</div>
        </div>
        <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap;">
          <span class="zoom-hint">🔍 ドラッグでズーム</span>
          <button class="zoom-reset-btn" onclick="resetTrendZoom()">リセット</button>
        </div>
      </div>
      <div style="position:relative;height:520px;"><canvas id="trendChart"></canvas></div>
    </div>

    <div class="chart-card" id="monthlyTrendCard" style="display:none;">
      <div class="chart-header">
        <div>
          <div class="chart-title">月別 歌唱回数推移</div>
          <div class="chart-subtitle">各月の歌唱回数（全楽曲合計）</div>
        </div>
        <div style="display:flex;gap:5px;">
          <span class="zoom-hint">🔍 ドラッグでズーム</span>
          <button class="zoom-reset-btn" onclick="resetMonthlyZoom()">リセット</button>
        </div>
      </div>
      <div style="position:relative;height:280px;"><canvas id="monthlyCountChart"></canvas></div>
    </div>
  </div>

  <!-- ===== TAB: 公演別 ===== -->
  <div id="tab-event" class="tab-content">
  <!-- モバイル用ドロワーオーバーレイ -->
  <div id="evDrawerOverlay" onclick="closeEvDrawer()"></div>

    <!-- モード切り替え -->
    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;">
        <div style="display:flex;gap:6px;">
          <button class="mode-btn active" id="evModeBtnSetlist" onclick="setEventMode('setlist')">📋 セトリ確認</button>
          <button class="mode-btn" id="evModeBtnAnalyze" onclick="setEventMode('analyze')">📊 公演分析</button>
          <button class="mode-btn" id="evModeBtnCompare" onclick="setEventMode('compare')">🆚 グループ比較</button>
        </div>
        <div style="font-size:11px;color:var(--text-muted);" id="evModeDesc">公演を選んでセトリを確認します</div>
      </div>
    </div>

    <!-- 左右レイアウト -->
    <div style="display:grid;grid-template-columns:340px 1fr;gap:14px;" id="eventMainGrid">

      <!-- 左：公演選択 -->
      <div class="card" id="evListCard" style="margin-bottom:0;display:flex;flex-direction:column;max-height:700px;">
        <div class="card-title" style="flex-shrink:0;">🎤 公演を選択</div>

        <!-- 年フィルタ -->
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;flex-shrink:0;" id="evYearFilter">
          <label class="year-check-label"><input type="checkbox" class="ev-year-filter" value="2023" checked onchange="filterEventList()"> 2023</label>
          <label class="year-check-label"><input type="checkbox" class="ev-year-filter" value="2024" checked onchange="filterEventList()"> 2024</label>
          <label class="year-check-label"><input type="checkbox" class="ev-year-filter" value="2025" checked onchange="filterEventList()"> 2025</label>
          <label class="year-check-label"><input type="checkbox" class="ev-year-filter" value="2026" checked onchange="filterEventList()"> 2026</label>
        </div>

        <!-- 検索 -->
        <div class="event-search-box" style="flex-shrink:0;">
          <input class="event-search-input" id="eventSearch" placeholder="公演名で検索..." oninput="filterEventList()">
          <span class="event-search-icon">🔍</span>
        </div>

        <!-- 操作ボタン -->
        <div style="display:flex;gap:5px;margin-bottom:8px;flex-shrink:0;">
          <button class="btn" style="flex:1;padding:5px;font-size:11px;background:var(--pink-light);color:var(--pink-dark);" onclick="selectAllVisible()">全て選択</button>
          <button class="btn" style="flex:1;padding:5px;font-size:11px;background:#f3f4f6;color:#888;" onclick="clearAllSelection()">全て解除</button>
        </div>

        <!-- 選択中バッジ -->
        <div id="evSelCount" style="font-size:11px;color:var(--pink-dark);font-weight:700;margin-bottom:6px;flex-shrink:0;min-height:16px;"></div>

        <!-- リスト（スクロール） -->
        <div id="eventList" style="flex:1;overflow-y:auto;"></div>
      </div>

      <!-- 右：モード別パネル -->
      <div id="evRightPanel">

        <!-- セトリ確認パネル -->
        <div id="evPanelSetlist">
          <div class="card" style="margin-bottom:12px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div class="card-title" style="margin-bottom:0;">📋 セトリ確認</div>
              <button class="btn" style="padding:4px 12px;font-size:11px;" onclick="resetEventPanel()">✕ リセット</button>
            </div>
            <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">左から公演を1件選択すると、そのセトリが表示されます</p>
            <div id="setlistDisplay" style="display:none;">
              <div style="font-size:14px;font-weight:700;color:var(--pink-dark);margin-bottom:4px;" id="setlistTitle"></div>
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;" id="setlistMeta"></div>
              <div id="setlistSongs" style="display:flex;flex-direction:column;gap:4px;"></div>
            </div>
            <div id="setlistEmpty" style="color:var(--text-muted);font-size:12px;padding:20px 0;text-align:center;">
              <div style="font-size:32px;margin-bottom:8px;">🎵</div>
              公演を1つ選択してください
            </div>
          </div>
        </div>

        <!-- 公演分析パネル -->
        <div id="evPanelAnalyze" style="display:none;">
          <div class="card" style="margin-bottom:12px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
              <div class="card-title" style="margin-bottom:0;">⚙️ 分析設定</div>
              <button class="btn" style="padding:4px 12px;font-size:11px;" onclick="resetEventPanel()">✕ リセット</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;">
              <div class="field"><label>分析カテゴリ</label>
                <select id="evColumnSelect">
                  <option value="song">★ 楽曲別 歌唱回数</option>
                  <option value="first">【1曲目】出現回数</option>
                  <option value="last">【トリ】出現回数</option>
                  <option value="combo">鉄板コンボ</option>
                </select>
              </div>
              <div class="field"><label>グラフ種別</label>
                <select id="evChartTypeSelect">
                  <option value="horizontalBar">横棒グラフ</option>
                  <option value="bar">縦棒グラフ</option>
                  <option value="pie">円グラフ</option>
                  <option value="doughnut">ドーナツグラフ</option>
                </select>
              </div>
              <div class="field"><label>表示件数</label>
                <select id="evLimitSelect">
                  <option value="10">上位10件</option>
                  <option value="20" selected>上位20件</option>
                  <option value="30">上位30件</option>
                  <option value="999">全件</option>
                </select>
              </div>
            </div>
            <div class="btn-row" style="margin-top:10px;">
              <button class="btn btn-primary" onclick="analyzeEvents()">📊 分析実行</button>
            </div>
          </div>
          <div class="chart-card" id="evChartCard" style="display:none;">
            <div class="chart-header">
              <div>
                <div class="chart-title" id="evChartTitle">公演別分析結果</div>
                <div class="chart-subtitle" id="evChartSub"></div>
              </div>
              <div style="display:flex;gap:5px;align-items:center;">
                <span class="zoom-hint">🔍 ドラッグでズーム</span>
                <button class="zoom-reset-btn" onclick="resetEvZoom()">リセット</button>
              </div>
            </div>
            <div style="position:relative;height:460px;"><canvas id="evChart"></canvas></div>
          </div>
        </div>

        <!-- グループ比較パネル -->
        <div id="evPanelCompare" style="display:none;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div class="card" style="margin-bottom:0;">
              <div class="card-title" style="color:var(--pink-dark);">🅰 Group A</div>
              <div class="ev-slot-tags" id="evTagsA"><span style="font-size:11px;color:var(--text-muted);">公演を選択して「Aに追加」</span></div>
              <button class="btn" style="width:100%;margin-top:8px;padding:6px;font-size:12px;background:rgba(244,114,182,0.15);color:var(--pink-dark);" onclick="addToSlot('A')">✚ Aに追加</button>
            </div>
            <div class="card" style="margin-bottom:0;">
              <div class="card-title" style="color:#a07c00;">🅱 Group B</div>
              <div class="ev-slot-tags" id="evTagsB"><span style="font-size:11px;color:var(--text-muted);">公演を選択して「Bに追加」</span></div>
              <button class="btn" style="width:100%;margin-top:8px;padding:6px;font-size:12px;background:rgba(212,175,55,0.15);color:#a07c00;" onclick="addToSlot('B')">✚ Bに追加</button>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap;">
            <button class="btn btn-gold" onclick="compareSlots()">🆚 グループ比較実行</button>
            <button class="btn btn-secondary" onclick="clearSlots()" style="padding:7px 14px;font-size:12px;">クリア</button>
            <div class="field" style="margin-bottom:0;min-width:120px;">
              <select id="evCompareCat">
                <option value="song">全楽曲</option>
                <option value="first">1曲目</option>
                <option value="last">トリ</option>
              </select>
            </div>
          </div>
          <div class="chart-card" id="evCompareCard" style="display:none;">
            <div class="chart-header">
              <div>
                <div class="chart-title" id="evCompareTitle">グループ比較</div>
                <div class="chart-subtitle" id="evCompareSub"></div>
              </div>
              <div style="display:flex;gap:5px;align-items:center;">
                <span class="zoom-hint">🔍 ドラッグでズーム</span>
                <button class="zoom-reset-btn" onclick="resetEvCompareZoom()">リセット</button>
              </div>
            </div>
            <div style="position:relative;height:500px;"><canvas id="evCompareChart"></canvas></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ===== TAB: 都道府県 ===== -->
  <div id="tab-pref" class="tab-content">
    <div class="card">
      <div class="card-title">🗾 Prefecture Analysis</div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span style="font-size:11px;font-weight:700;color:var(--text-muted);">対象年：</span>
        <label class="year-check-label"><input type="checkbox" class="pref-year-cb" value="2023" onchange="loadPrefData()"><span class="year-dot" style="background:#a78bfa;"></span>2023</label>
        <label class="year-check-label"><input type="checkbox" class="pref-year-cb" value="2024" onchange="loadPrefData()"><span class="year-dot" style="background:#d4af37;"></span>2024</label>
        <label class="year-check-label"><input type="checkbox" class="pref-year-cb" value="2025" checked onchange="loadPrefData()"><span class="year-dot" style="background:#f472b6;"></span>2025</label>
        <label class="year-check-label"><input type="checkbox" class="pref-year-cb" value="2026" onchange="loadPrefData()"><span class="year-dot" style="background:#34d399;"></span>2026</label>
        <span style="font-size:10px;color:var(--text-muted);">※複数年選択で合算表示</span>
      </div>
    </div>

    <div id="prefSummary" style="display:none;margin-bottom:14px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(125px,1fr));gap:10px;">
        <div class="stat-badge" id="ps-visited"></div>
        <div class="stat-badge" id="ps-events"></div>
        <div class="stat-badge" id="ps-top"></div>
        <div class="stat-badge" id="ps-abroad"></div>
      </div>
    </div>

    <div class="chart-card" style="min-height:auto;">
      <div class="chart-title" style="margin-bottom:12px;">都道府県別 訪問回数</div>
      <div id="prefGrid" class="pref-grid"></div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="prefChartTitle">都道府県別 TOP曲</div>
          <div class="chart-subtitle" id="prefChartSub">都道府県カードをクリックすると詳細を表示</div>
        </div>
        <div style="display:flex;gap:5px;">
          <span class="zoom-hint">🔍 ドラッグでズーム</span>
          <button class="zoom-reset-btn" onclick="resetPrefZoom()">リセット</button>
        </div>
      </div>
      <div style="position:relative;height:360px;">
        <canvas id="prefChart"></canvas>
        <div class="empty-state" id="prefEmptyState">
          <div class="empty-icon">🗾</div>
          <div class="empty-text">都道府県カードをクリックしてください</div>
        </div>
      </div>
    </div>
  </div>


</main>

<!-- MOBILE NAV -->
<div class="mobile-nav" id="mobileNav">
  <button class="mobile-nav-btn active" id="mnav-analyze" onclick="switchTab('analyze')"><span class="mobile-nav-icon">🎵</span>楽曲分析</button>
  <button class="mobile-nav-btn" id="mnav-compare" onclick="switchTab('compare')"><span class="mobile-nav-icon">📈</span>年度比較</button>
  <button class="mobile-nav-btn" id="mnav-event" onclick="switchTab('event')"><span class="mobile-nav-icon">🎤</span>公演別</button>
  <button class="mobile-nav-btn" id="mnav-pref" onclick="switchTab('pref')"><span class="mobile-nav-icon">🗾</span>都道府県</button>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">NOW ANALYZING...</div>
</div>

<!-- DRILL MODAL -->
<div id="drillModal" class="drill-modal">
  <div class="drill-inner">
    <div class="drill-head">
      <div>
        <div id="drillSongName" style="font-size:18px;font-weight:700;color:#fff;"></div>
        <div id="drillSongSub" style="font-size:11px;color:rgba(255,255,255,0.75);margin-top:3px;"></div>
      </div>
      <button class="drill-close" onclick="closeDrill()">✕</button>
    </div>
    <div class="drill-body">
      <div id="drillYearGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:18px;"></div>
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:9px;">📅 月別 歌唱推移（全年重ね合わせ）</div>
      <div style="position:relative;height:200px;margin-bottom:16px;"><canvas id="drillMonthChart"></canvas></div>
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px;">📋 出演イベント（最大20件）</div>
      <div id="drillEventList" style="display:flex;flex-direction:column;gap:5px;max-height:240px;overflow-y:auto;"></div>
    </div>
  </div>
</div>

<script>
// ============================================================
// 設定
// ============================================================
const SHEET_ID = '10QKtPdhdtaLFxxkRhdzTRVePeh3DUmib0WpEJA49Erw';
const SHEET_NAMES = {
  '2023':'楽曲分解シート（2023）',
  '2024':'楽曲分解シート（2024）',
  '2025':'楽曲分解シート（2025）',
  '2026':'楽曲分解シート（2026）',
};
// 年別シート（アンコールセトリ取得用）
const YEAR_SHEET_NAMES = {
  '2023':'2023', '2024':'2024', '2025':'2025', '2026':'2026',
};
// 年別シート列インデックス（0始まり）
// A:日付表示 B:計算用日付 C:年 D:月 E:日 F:曜日 G:タイトル H:歌唱楽曲 I:備考 J:会場 K:都道府県 L:アンコール楽曲
const YC2 = { dateCalc:1, title:6, setlist:7, venue:9, pref:10, encore:11 };
const ALL_YEARS = ['2023','2024','2025','2026'];
const COLORS = [
  '#f472b6','#d4af37','#818cf8','#34d399','#fb923c',
  '#60a5fa','#e879f9','#4ade80','#f87171','#38bdf8',
  '#fbbf24','#a78bfa','#fb7185','#2dd4bf','#c084fc',
  '#f9a8d4','#86efac','#93c5fd','#fcd34d','#6ee7b7'
];

// 楽曲分解シート v4 列インデックス（0始まり）
// A〜K: 詳細データ行
const C = {
  date:0, month:1, title:2, rawSong:3, song:4, count:5, ratio:6,
  venue:7, pref:8, isFirst:9, isLast:10,
  // L〜 集計ブロック（各ブロック2列）
  b1n:11,b1c:12, // 1曲目
  b2n:13,b2c:14, // トリ
  b3n:15,b3c:16, // 春
  b4n:17,b4c:18, // 夏
  b5n:19,b5c:20, // 秋
  b6n:21,b6c:22, // 冬
  b7n:23,b7c:24, // 少曲数1曲目
  b8n:25,b8c:26, // 多曲数1曲目
  b9n:27,b9c:28, // コンボ
  prefRankN:29,prefRankC:30, // 都道府県訪問ランキング
  prefTopStart:31, // 都道府県別TOP曲（可変列）
};

const CAT_COL = {
  song:{n:C.song,c:C.count},       first:{n:C.b1n,c:C.b1c},
  last:{n:C.b2n,c:C.b2c},          spring:{n:C.b3n,c:C.b3c},
  summer:{n:C.b4n,c:C.b4c},        autumn:{n:C.b5n,c:C.b5c},
  winter:{n:C.b6n,c:C.b6c},        shortFirst:{n:C.b7n,c:C.b7c},
  longFirst:{n:C.b8n,c:C.b8c},     combo:{n:C.b9n,c:C.b9c},
};

const CAT_LABEL = {
  song:'全楽曲',first:'1曲目',last:'トリ',spring:'春(3-5月)',summer:'夏(6-8月)',
  autumn:'秋(9-11月)',winter:'冬(12-2月)',shortFirst:'少曲数1曲目',longFirst:'多曲数1曲目',
  combo:'鉄板コンボ',fesFirst:'フェス1曲目',fesSong:'フェスTOP曲',
  onemanFirst:'ワンマン1曲目',onemanSong:'ワンマンTOP曲',multiFirst:'二部制1曲目',
  encoreTop:'アンコール回数TOP',encoreRate:'アンコール率TOP',
};

// ============================================================
// データ取得
// ============================================================
const sheetCache = {};
async function fetchSheet(year) {
  if (sheetCache[year]) return sheetCache[year];
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAMES[year])}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('取得失敗: '+year);
  const rows = parseCSV(await res.text());
  sheetCache[year] = rows;
  return rows;
}

const yearSheetCache = {};
async function fetchYearSheet(year) {
  if (yearSheetCache[year]) return yearSheetCache[year];
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(YEAR_SHEET_NAMES[year])}`;
  const res = await fetch(url);
  if (!res.ok) return null;
  const rows = parseCSV(await res.text());
  yearSheetCache[year] = rows;
  return rows;
}

function parseCSV(text) {
  return text.split('\n').map(line => {
    const r=[]; let q=false,cur='';
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;}
      else if(ch===','&&!q){r.push(cur.trim());cur='';}
      else cur+=ch;
    }
    r.push(cur.trim()); return r;
  }).filter(r=>r.length>1&&r[0]);
}

function parseDate(v) {
  if (!v) return null;
  const s = String(v).trim();
  if (/^\d{5}/.test(s)) {
    const n=parseFloat(s); if(isNaN(n)) return null;
    const d=new Date(Math.round((n-25569)*86400*1000));
    return isNaN(d.getTime())?null:d;
  }
  const d=new Date(s.replace(/\//g,'-'));
  return isNaN(d.getTime())?null:d;
}

function isDataRow(row) {
  const v = String(row[C.date]||'').trim();
  return /^\d{5}/.test(v) || /^\d{4}[\/\-]/.test(v);
}

// 都道府県ブロック後の列を動的検出
function detectNewCols(rows) {
  const h = rows[0]||[];
  let prefCols=0, col=C.prefTopStart;
  while(col<h.length && h[col] && String(h[col]).indexOf('TOP曲')!==-1){prefCols++;col+=2;}
  const m12 = C.prefTopStart + prefCols*2; // 月別ブロック
  const b13  = m12 + 14;                   // フェス等ブロック
  return {
    prefTopStart:C.prefTopStart, prefTopCols:prefCols,
    fesFirstN:b13,fesFirstC:b13+1,
    fesSongN:b13+2,fesSongC:b13+3,
    onemanFirstN:b13+4,onemanFirstC:b13+5,
    onemanSongN:b13+6,onemanSongC:b13+7,
    multiFirstN:b13+8,multiFirstC:b13+9,
    encoreTopN:b13+10,encoreTopC:b13+11,         // アンコールTOP（回数）
    encoreRateN:b13+12,encoreRateNorm:b13+13,     // アンコール率TOP（曲名・通常回数）
    encoreRateC:b13+14,encoreRateR:b13+15,        // アンコール率TOP（アンコール回数・率）
  };
}

// ============================================================
// 集計
// ============================================================
function aggRaw(rows, startDate, endDate) {
  const m={};
  rows.slice(2).forEach(row=>{
    if(!isDataRow(row)) return;
    if(startDate||endDate){const d=parseDate(row[C.date]);if(!d)return;if(startDate&&d<startDate)return;if(endDate&&d>endDate)return;}
    const n=row[C.rawSong]; if(!n||!n.trim()) return;
    m[n]=(m[n]||0)+1;
  });
  return Object.entries(m).sort((a,b)=>b[1]-a[1]);
}

function aggRanking(rows, nameCol, cntCol) {
  const m={};
  rows.slice(2).forEach(row=>{
    const n=row[nameCol],c=parseFloat(row[cntCol]);
    if(!n||!n.trim()||n==='曲名'||n==='ペア'||n==='都道府県'||n==='訪問都道府県ランキング'||n==='訪問都道府県数') return;
    if(isNaN(c)||c<=0) return;
    if(!m[n]) m[n]=c;
  });
  return Object.entries(m).sort((a,b)=>b[1]-a[1]);
}

function aggData(rows, cat, startDate, endDate) {
  if(cat==='song') return aggRaw(rows,startDate,endDate);
  const nc=detectNewCols(rows);
  const extra={
    fesFirst:{n:nc.fesFirstN,c:nc.fesFirstC},
    fesSong:{n:nc.fesSongN,c:nc.fesSongC},
    onemanFirst:{n:nc.onemanFirstN,c:nc.onemanFirstC},
    onemanSong:{n:nc.onemanSongN,c:nc.onemanSongC},
    multiFirst:{n:nc.multiFirstN,c:nc.multiFirstC},
    encoreTop:{n:nc.encoreTopN,c:nc.encoreTopC},
    encoreRate:{n:nc.encoreRateN,c:nc.encoreRateR},  // 率でソート
  };
  const cfg=CAT_COL[cat]||extra[cat]; if(!cfg) return [];
  return aggRanking(rows,cfg.n,cfg.c);
}

function getSongDetails(rows, songName) {
  const monthly={}; for(let m=1;m<=12;m++) monthly[m]=0;
  const events=[]; const seen=new Set();
  rows.slice(2).forEach(row=>{
    if(!isDataRow(row)) return;
    if(row[C.rawSong]!==songName) return;
    const d=parseDate(row[C.date]); if(!d) return;
    monthly[d.getMonth()+1]++;
    const key=row[C.date]+'_'+(row[C.title]||'');
    if(!seen.has(key)){seen.add(key);events.push({date:d,title:row[C.title]||'不明',venue:row[C.venue]||'',pref:row[C.pref]||''});}
  });
  events.sort((a,b)=>b.date-a.date);
  return {monthly,events:events.slice(0,20)};
}

// ============================================================
// チャートユーティリティ
// ============================================================
Chart.register(ChartDataLabels);

function resetCanvas(id) {
  const el=document.getElementById(id); if(!el) return null;
  const p=el.parentNode;
  const nc=document.createElement('canvas'); nc.id=id; nc.style.cssText=el.style.cssText||'';
  p.replaceChild(nc,el);
  return document.getElementById(id).getContext('2d');
}

function destroyChart(inst) { if(inst){try{inst.destroy();}catch(e){}} return null; }

const ZoomPlugin = { zoom:{drag:{enabled:true,backgroundColor:'rgba(244,114,182,0.12)',borderColor:'rgba(244,114,182,0.4)',borderWidth:1},mode:'x'},pan:{enabled:false} };
const ZoomPluginY = { zoom:{drag:{enabled:true,backgroundColor:'rgba(244,114,182,0.12)',borderColor:'rgba(244,114,182,0.4)',borderWidth:1},mode:'y'},pan:{enabled:false} };

function datalabelCfg(type) {
  if(type==='pie'||type==='doughnut') return {color:'#fff',font:{family:'DM Mono',size:11,weight:'bold'},formatter:v=>v>0?v+'回':''};
  if(type==='horizontalBar') return {anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'回':'',padding:{left:3}};
  return {anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'回':'',padding:{bottom:3}};
}

function buildChart(type, labels, data, label, onClickFn) {
  const colors=labels.map((_,i)=>COLORS[i%COLORS.length]);
  const isH=type==='horizontalBar';
  if(type==='pie'||type==='doughnut') {
    return {type,data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'right',labels:{font:{family:'Zen Maru Gothic',size:11},padding:10,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${ctx.parsed}回`}},datalabels:datalabelCfg(type)}}};
  }
  return {
    type:'bar',
    data:{labels,datasets:[{label,data,backgroundColor:colors,borderRadius:isH?5:7,borderSkipped:false}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      ...(isH?{indexAxis:'y'}:{}),
      onClick:onClickFn||undefined,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>` ${isH?ctx.parsed.x:ctx.parsed.y}回`}},
        datalabels:datalabelCfg(type),
        zoom:isH?ZoomPluginY:ZoomPlugin,
      },
      scales:{
        x:{grid:{display:!isH,color:'rgba(0,0,0,0.04)'},ticks:{font:{family:isH?'DM Mono':'Zen Maru Gothic',size:10},maxRotation:isH?0:35}},
        y:{grid:{display:isH,color:'rgba(0,0,0,0.04)'},ticks:{font:{family:isH?'Zen Maru Gothic':'DM Mono',size:isH?11:10}},beginAtZero:true}
      }
    }
  };
}

// ============================================================
// 分析実行
// ============================================================
let mainChartInst=null;

async function analyze() {
  const years=[...document.querySelectorAll('.an-year-cb:checked')].map(cb=>cb.value);
  if(!years.length){alert('対象年を1つ以上選択してください');return;}
  const cat=document.getElementById('columnSelect').value;
  const chartType=document.getElementById('chartTypeSelect').value;
  const limit=parseInt(document.getElementById('limitSelect').value);
  const sd=document.getElementById('startDate').value?new Date(document.getElementById('startDate').value):null;
  const ed=document.getElementById('endDate').value?new Date(document.getElementById('endDate').value+'T23:59:59'):null;

  showLoading(true);
  try {
    // 全選択年のデータ取得
    const rowsMap={};
    for(const yr of years){ rowsMap[yr]=await fetchSheet(yr); }

    let results;
    if(years.length===1){
      results=aggData(rowsMap[years[0]],cat,sd,ed);
    } else {
      const merged={};
      for(const yr of years){
        aggData(rowsMap[yr],cat,sd,ed).forEach(([name,cnt])=>{ merged[name]=(merged[name]||0)+cnt; });
      }
      results=Object.entries(merged).sort((a,b)=>b[1]-a[1]);
    }

    if(!results.length){alert('該当データなし。条件を変更してください。');return;}

    const limited=results.slice(0,limit===999?results.length:limit);
    const total=results.reduce((s,r)=>s+r[1],0);

    document.getElementById('stat-songs').textContent=results.length+'曲';
    document.getElementById('stat-total').textContent=total+'回';
    document.getElementById('stat-top').textContent=results[0][0];
    document.getElementById('statsRow').style.display='flex';

    const labels=limited.map(r=>r[0]);
    const data=limited.map(r=>r[1]);
    const colLabel=document.getElementById('columnSelect').selectedOptions[0].text;
    const yearLabel=years.length===1?years[0]+'年':years.join('・')+'年';

    document.getElementById('emptyState').style.display='none';
    document.getElementById('chartTitleText').textContent=`${yearLabel} ${colLabel}`;
    document.getElementById('chartSubtitle').textContent=`上位${limited.length}件 / 全${results.length}曲 — バーをクリックで詳細`;

    mainChartInst=destroyChart(mainChartInst);
    const ctx=resetCanvas('mainChart');

    const onClickFn=(cat!=='combo')?(evt,els)=>{
      if(els.length>0){
        const r=limited[els[0].index];
        const sd_={total:r[1]}; years.forEach(yr=>sd_['v'+yr]=0);
        openDrillMulti(r[0],rowsMap,sd_,years);
      }
    }:null;

    mainChartInst=new Chart(ctx,buildChart(chartType,labels,data,colLabel,onClickFn));
    if(cat!=='combo') document.getElementById('mainChart').style.cursor='pointer';

    if(currentAnalyzeMode==='category'){
      document.getElementById('rankingSection').style.display='block';
      renderRanking(results,limit,rowsMap,years);
    }
  } catch(e){alert('データ取得失敗: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function resetMainZoom(){if(mainChartInst) mainChartInst.resetZoom();}

// ============================================================
// ランキング
// ============================================================
function renderRanking(results,limit,rowsMap,years) {
  const grid=document.getElementById('rankingGrid'); grid.innerHTML='';
  const max=results[0]?.[1]||1;
  const count=limit===999?results.length:limit;
  results.slice(0,count).forEach(([name,cnt],i)=>{
    const rank=i+1; const rc=rank===1?'top1':rank===2?'top2':rank===3?'top3':'';
    const pct=Math.round((cnt/max)*100);
    const el=document.createElement('div'); el.className='ranking-item';
    el.onclick=()=>{
      const sd={total:cnt}; years.forEach(yr=>sd['v'+yr]=0);
      openDrillMulti(name,rowsMap,sd,years);
    };
    el.innerHTML=`<span class="rank-num ${rc}">${rank}</span>
      <div style="flex:1;overflow:hidden;">
        <div class="rank-name">${name}</div>
        <div class="rank-bar-wrap"><div class="rank-bar" style="width:${pct}%"></div></div>
      </div><span class="rank-count">${cnt}回</span>`;
    grid.appendChild(el);
  });
}

// ============================================================
// ドリルダウン（単体年・複数年対応）
// ============================================================
let drillInst=null;

// 単体分析タブからのドリルダウン（クリックした年のデータのみ表示）
function openDrill(songName,rows,songData,year) {
  // 単体年の場合は全年データをキャッシュから補完
  const allYears=Object.keys(sheetCache).sort();
  const rowsMap={};
  allYears.forEach(yr=>{ if(sheetCache[yr]) rowsMap[yr]=sheetCache[yr]; });
  // 現在の year は必ず含める
  rowsMap[year]=rows;

  // 各年の合計を集計
  const yearTotals={};
  Object.keys(rowsMap).forEach(yr=>{
    let cnt=0;
    rowsMap[yr].slice(2).forEach(r=>{
      if(!isDataRow(r)) return;
      if(r[C.rawSong]===songName) cnt++;
    });
    yearTotals[yr]=cnt;
  });

  // songData に正しい年別値を補完
  const enriched={...songData};
  Object.keys(yearTotals).forEach(yr=>{ enriched['v'+yr]=yearTotals[yr]; });
  enriched.total=Object.values(yearTotals).reduce((a,b)=>a+b,0);

  _openDrillModal(songName, rowsMap, enriched, Object.keys(rowsMap).sort(), year);
}

// 年度比較タブからのドリルダウン（複数年対応）
function openDrillMulti(songName,rowsMap,songData,years) {
  _openDrillModal(songName, rowsMap, songData, years, null);
}

function _openDrillModal(songName, rowsMap, songData, years, focusYear) {
  document.getElementById('drillSongName').textContent=songName;
  const total=songData.total||years.reduce((s,yr)=>s+(songData['v'+yr]||0),0);
  const yearStr=focusYear?focusYear+'年':years.join('・')+'年';
  document.getElementById('drillSongSub').textContent=`${yearStr} 合計: ${total}回`;

  // 年別サマリーバッジ（動的生成）
  const yrGrid=document.getElementById('drillYearGrid');
  yrGrid.innerHTML='';
  const sortedYears=[...years].sort();
  sortedYears.forEach((yr,i)=>{
    const cnt=songData['v'+yr]||0;
    const yc=YEAR_COLORS[yr]||{border:'#888'};
    const div=document.createElement('div'); div.className='stat-badge';
    let html=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:3px;">${yr}年</div>
      <div style="font-size:24px;font-weight:700;color:${yc.border};">${cnt}回</div>`;
    if(i>0){
      const prevYr=sortedYears[i-1];
      const prev=songData['v'+prevYr]||0;
      const delta=cnt-prev;
      const growth=prev>0?((delta/prev)*100).toFixed(1):'—';
      html+=`<div style="font-size:10px;color:${delta>=0?'#34d399':'#f87171'};font-weight:700;margin-top:2px;">${delta>=0?'▲':'▼'}${Math.abs(delta)} (${delta>=0?'+':''}${growth}%)</div>`;
    }
    div.innerHTML=html;
    yrGrid.appendChild(div);
  });

  // 月別グラフ（全比較年 or 単体年）
  drillInst=destroyChart(drillInst);
  const mths=['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
  const dctx=resetCanvas('drillMonthChart');

  const datasets=sortedYears.map(yr=>{
    const det=getSongDetails(rowsMap[yr]||[],songName);
    const yc=YEAR_COLORS[yr]||{border:'#f472b6',bg:'rgba(244,114,182,0.8)'};
    return {
      label:yr+'年',data:mths.map((_,i)=>det.monthly[i+1]),
      backgroundColor:yc.bg,borderColor:yc.border,borderRadius:5
    };
  });

  drillInst=new Chart(dctx,{
    type:'bar',
    data:{labels:mths,datasets},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'bottom',display:sortedYears.length>1,labels:{font:{family:'Zen Maru Gothic',size:10},padding:8,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}回`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:9,weight:'bold'},formatter:v=>v>0?v+'回':''}},
      scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}}
  });

  // イベント一覧（全年まとめて、最新20件）
  const allEvents=[];
  sortedYears.forEach(yr=>{
    const det=getSongDetails(rowsMap[yr]||[],songName);
    det.events.forEach(e=>allEvents.push({...e,year:yr}));
  });
  allEvents.sort((a,b)=>b.date-a.date);
  const top20=allEvents.slice(0,20);

  const evHtml=top20.map(e=>{
    const ds=`${e.date.getFullYear()}/${String(e.date.getMonth()+1).padStart(2,'0')}/${String(e.date.getDate()).padStart(2,'0')}`;
    const yc=YEAR_COLORS[e.year]||{border:'#888'};
    return `<div style="display:flex;gap:7px;align-items:flex-start;padding:6px 10px;background:var(--bg);border-radius:9px;">
      <span style="font-size:9px;font-weight:700;color:#fff;background:${yc.border};padding:2px 6px;border-radius:20px;flex-shrink:0;margin-top:2px;">${e.year}</span>
      <div style="flex:1;overflow:hidden;">
        <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.title}</div>
        <div style="font-size:10px;color:var(--text-muted);">${ds}${e.venue?' · '+e.venue:''}${e.pref?' 📍'+e.pref:''}</div>
      </div></div>`;
  }).join('');
  document.getElementById('drillEventList').innerHTML=evHtml||'<div style="color:var(--text-muted);font-size:13px;">イベント情報なし</div>';

  document.getElementById('drillModal').style.display='block';
  document.body.style.overflow='hidden';
}

function closeDrill(){document.getElementById('drillModal').style.display='none';document.body.style.overflow='';drillInst=destroyChart(drillInst);}



// ============================================================
// 年度比較（全年チェックボックス対応）
// ============================================================
let evChartInst=null,moChartInst=null,trChartInst=null,mcChartInst=null;
let compareCategory='song';

const YEAR_COLORS = {
  '2023':{ border:'#a78bfa', bg:'rgba(167,139,250,0.85)', bgFill:'rgba(167,139,250,0.1)' },
  '2024':{ border:'#d4af37', bg:'rgba(212,175,55,0.85)',   bgFill:'rgba(212,175,55,0.1)'  },
  '2025':{ border:'#f472b6', bg:'rgba(244,114,182,0.85)', bgFill:'rgba(244,114,182,0.1)' },
  '2026':{ border:'#34d399', bg:'rgba(52,211,153,0.85)',  bgFill:'rgba(52,211,153,0.1)'  },
};

function getCheckedYears(){
  return [...document.querySelectorAll('.year-cb:checked')].map(cb=>cb.value);
}

function setCompareCategory(btn,cat){
  document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); compareCategory=cat; runCompare();
}

function resetCompare(){
  document.getElementById('compareStart').value='';
  document.getElementById('compareEnd').value='';
  document.getElementById('compareLimit').value='15';
  compareCategory='song';
  document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.cat-btn[data-cat="song"]').classList.add('active');
  document.querySelectorAll('.year-cb').forEach(cb=>{ cb.checked=true; });
  Object.keys(sheetCache).forEach(k=>delete sheetCache[k]);
  runCompare();
}

function buildMap(rows,cat,sd,ed){
  if(cat==='song'){
    const m={};
    rows.slice(2).forEach(row=>{
      if(!isDataRow(row)) return;
      if(sd||ed){const d=parseDate(row[C.date]);if(!d)return;if(sd&&d<sd)return;if(ed&&d>ed)return;}
      const n=row[C.rawSong]; if(!n||!n.trim()) return; m[n]=(m[n]||0)+1;
    });
    return m;
  }
  const nc=detectNewCols(rows);
  const extra={
    fesFirst:{n:nc.fesFirstN,c:nc.fesFirstC},fesSong:{n:nc.fesSongN,c:nc.fesSongC},
    onemanFirst:{n:nc.onemanFirstN,c:nc.onemanFirstC},onemanSong:{n:nc.onemanSongN,c:nc.onemanSongC},
    multiFirst:{n:nc.multiFirstN,c:nc.multiFirstC}
  };
  const cfg=CAT_COL[cat]||extra[cat]; if(!cfg) return {};
  const m={};
  rows.slice(2).forEach(row=>{
    const n=row[cfg.n],c=parseFloat(row[cfg.c]);
    if(!n||!n.trim()||n==='曲名'||n==='ペア') return;
    if(isNaN(c)||c<=0) return;
    if(!m[n]) m[n]=c;
  });
  return m;
}

async function runCompare(){
  const years=getCheckedYears();
  if(years.length===0){alert('比較対象年を1つ以上選択してください。');return;}
  showLoading(true);
  try {
    const sv=document.getElementById('compareStart').value;
    const ev_=document.getElementById('compareEnd').value;
    const sd=sv?new Date(sv+'-01'):null;
    const ed=ev_?new Date(ev_+'-01T23:59:59'):null;
    if(ed) ed.setMonth(ed.getMonth()+1);
    const limit=parseInt(document.getElementById('compareLimit').value)||15;
    const cat=compareCategory;
    const mths=['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];

    // 全選択年のデータ取得
    const rowsMap={};
    for(const yr of years){ rowsMap[yr]=await fetchSheet(yr); }

    // 公演数 + 月別公演数
    const evCnt={};
    const moEv={}; for(let m=1;m<=12;m++){moEv[m]={}; years.forEach(yr=>moEv[m][yr]=0);}
    for(const yr of years){
      const rows=rowsMap[yr]; const seen=new Set();
      rows.slice(2).forEach(row=>{
        if(!isDataRow(row)) return;
        const d=parseDate(row[C.date]); if(!d) return;
        if(sd&&d<sd) return; if(ed&&d>ed) return;
        const key=row[C.date]+'_'+(row[C.title]||'');
        if(!seen.has(key)){seen.add(key);moEv[d.getMonth()+1][yr]++;}
      });
      evCnt[yr]=seen.size;
    }

    // カテゴリ集計
    const maps={};
    for(const yr of years){ maps[yr]=buildMap(rowsMap[yr],cat,sd,ed); }

    const allNames=[...new Set(years.flatMap(yr=>Object.keys(maps[yr])))];
    const combined=allNames.map(name=>{
      const obj={name}; let total=0;
      years.forEach(yr=>{ const v=maps[yr][name]||0; obj['v'+yr]=v; total+=v; });
      obj.total=total; return obj;
    }).sort((a,b)=>b.total-a.total).slice(0,limit);

    const catL=CAT_LABEL[cat]||cat;
    document.getElementById('compareChartTitle').textContent=`${catL} 年度比較 (Top${limit})`;
    document.getElementById('compareChartSub').textContent=`${years.join('・')}年 / バーをクリックで詳細 / ドラッグでズーム`;

    // サマリーカード（年ごと動的生成）
    document.getElementById('compareSummary').style.display='block';
    const sgrid=document.getElementById('compareSummaryGrid');
    sgrid.innerHTML='';
    years.forEach(yr=>{
      const total=Object.values(maps[yr]).reduce((a,b)=>a+b,0);
      const yc=YEAR_COLORS[yr]||{border:'#888'};
      const div=document.createElement('div'); div.className='stat-badge';
      div.innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">${yr}年 総歌唱数</div>
        <div style="font-size:22px;font-weight:700;color:${yc.border};">${total.toLocaleString()}</div>
        <div style="font-size:10px;color:var(--text-muted);">${evCnt[yr]}公演</div>`;
      sgrid.appendChild(div);
    });
    if(years.length>=2){
      const sorted=[...years].sort();
      const first=sorted[0],last=sorted[sorted.length-1];
      const tf=Object.values(maps[first]).reduce((a,b)=>a+b,0);
      const tl=Object.values(maps[last]).reduce((a,b)=>a+b,0);
      const delta=tl-tf; const growth=tf>0?((delta/tf)*100).toFixed(1):'—';
      const div2=document.createElement('div'); div2.className='stat-badge';
      div2.innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">${first}→${last} 成長率</div>
        <div style="font-size:22px;font-weight:700;color:${delta>=0?'#34d399':'#f87171'};">${tf>0?(delta>=0?'+':'')+growth+'%':'N/A'}</div>
        <div style="font-size:10px;color:var(--text-muted);">${delta>=0?'+':''} ${delta.toLocaleString()}回</div>`;
      sgrid.appendChild(div2);
    }

    // 公演数グラフ
    evChartInst=destroyChart(evChartInst);
    evChartInst=new Chart(resetCanvas('eventChart'),{
      type:'bar',
      data:{labels:years.map(y=>y+'年'),datasets:[{data:years.map(yr=>evCnt[yr]),backgroundColor:years.map(yr=>(YEAR_COLORS[yr]||{bg:'#888'}).bg),borderRadius:10,borderSkipped:false}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}公演`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:11,weight:'bold'},formatter:v=>v+'公演'}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:11}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
    });

    // 月別公演グラフ
    moChartInst=destroyChart(moChartInst);
    moChartInst=new Chart(resetCanvas('monthlyChart'),{
      type:'line',
      data:{labels:mths,datasets:years.map(yr=>({
        label:yr,data:mths.map((_,i)=>moEv[i+1][yr]),
        borderColor:(YEAR_COLORS[yr]||{border:'#888'}).border,
        backgroundColor:(YEAR_COLORS[yr]||{bgFill:'rgba(0,0,0,0.05)'}).bgFill,
        fill:true,tension:0.4,pointRadius:4,pointHoverRadius:7
      }))},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{family:'Zen Maru Gothic',size:10},padding:8,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}公演`}},datalabels:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
    });

    // メイントレンドグラフ（横棒）
    const isCombo=cat==='combo';
    trChartInst=destroyChart(trChartInst);
    trChartInst=new Chart(resetCanvas('trendChart'),{
      type:'bar',
      data:{
        labels:combined.map(d=>d.name.length>16?d.name.slice(0,16)+'…':d.name),
        datasets:years.map(yr=>({
          label:yr+'年',data:combined.map(d=>d['v'+yr]||0),
          backgroundColor:(YEAR_COLORS[yr]||{bg:'#888'}).bg,borderRadius:4,borderSkipped:false
        }))
      },
      options:{
        indexAxis:'y',responsive:true,maintainAspectRatio:false,
        onClick:(evt,els)=>{
          if(els.length>0&&!isCombo){
            const d=combined[els[0].index];
            openDrillMulti(d.name,rowsMap,d,years);
          }
        },
        plugins:{
          legend:{position:'top',labels:{font:{family:'Zen Maru Gothic',size:11},padding:12,boxWidth:10}},
          tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.x}回`}},
          datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:9,weight:'bold'},formatter:v=>v>0?v+'回':''},
          zoom:ZoomPluginY,
        },
        scales:{x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}}},y:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:11}}}}
      }
    });
    if(!isCombo) document.getElementById('trendChart').style.cursor='pointer';

    // 月別歌唱推移
    const mcCard=document.getElementById('monthlyTrendCard');
    if(cat==='song'){
      mcCard.style.display='block';
      const mc={}; for(let m=1;m<=12;m++){mc[m]={}; years.forEach(yr=>mc[m][yr]=0);}
      for(const yr of years){
        rowsMap[yr].slice(2).forEach(row=>{
          if(!isDataRow(row)) return;
          const d=parseDate(row[C.date]); if(!d) return;
          if(sd&&d<sd) return; if(ed&&d>ed) return;
          const n=row[C.rawSong]; if(!n||!n.trim()) return;
          mc[d.getMonth()+1][yr]++;
        });
      }
      mcChartInst=destroyChart(mcChartInst);
      mcChartInst=new Chart(resetCanvas('monthlyCountChart'),{
        type:'line',
        data:{labels:mths,datasets:years.map(yr=>({
          label:yr,data:mths.map((_,i)=>mc[i+1][yr]),
          borderColor:(YEAR_COLORS[yr]||{border:'#888'}).border,
          backgroundColor:(YEAR_COLORS[yr]||{bgFill:'rgba(0,0,0,0.05)'}).bgFill,
          fill:true,tension:0.4,pointRadius:5,pointHoverRadius:8
        }))},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{family:'Zen Maru Gothic',size:11},padding:10,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}回`}},datalabels:{display:false},zoom:ZoomPlugin},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
      });
    } else { mcCard.style.display='none'; }

  } catch(e){alert('データ取得失敗: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function resetTrendZoom(){if(trChartInst) trChartInst.resetZoom();}
function resetMonthlyZoom(){if(mcChartInst) mcChartInst.resetZoom();}

// ============================================================
// 都道府県分析
// ============================================================
let prefChartInst=null;

async function loadPrefData(){
  const years = [...document.querySelectorAll('.pref-year-cb:checked')].map(cb=>cb.value);
  if(!years.length) { alert('対象年を1つ以上選択してください'); return; }
  showLoading(true);
  try {
    const prefMap={};
    const prefTopMaps={};

    for(const year of years){
      const rows=await fetchSheet(year);
      const nc=detectNewCols(rows);
      rows.slice(2).forEach(row=>{
        const n=row[C.prefRankN],c=parseFloat(row[C.prefRankC]);
        if(!n||!n.trim()||n==='都道府県'||n==='訪問都道府県ランキング'||n==='訪問都道府県数') return;
        if(isNaN(c)||c<=0) return;
        prefMap[n]=(prefMap[n]||0)+c;
      });
      if(nc.prefTopCols>0){
        const h=rows[0]||[];
        for(let p=0;p<nc.prefTopCols;p++){
          const nc_=nc.prefTopStart+p*2, cc_=nc.prefTopStart+p*2+1;
          const pname=String(h[nc_]||'').replace('TOP曲','').trim();
          if(!pname) continue;
          if(!prefTopMaps[pname]) prefTopMaps[pname]={};
          rows.slice(2).forEach(row=>{
            const sn=row[nc_],sc=parseFloat(row[cc_]);
            if(!sn||!sn.trim()||sn==='曲名') return;
            if(isNaN(sc)||sc<=0) return;
            prefTopMaps[pname][sn]=(prefTopMaps[pname][sn]||0)+sc;
          });
        }
      }
    }

    const prefSorted=Object.entries(prefMap).sort((a,b)=>b[1]-a[1]);
    const prefTopMap={};
    Object.entries(prefTopMaps).forEach(([pname,songs])=>{
      prefTopMap[pname]=Object.entries(songs).sort((a,b)=>b[1]-a[1]);
    });

    const totalEv=prefSorted.reduce((s,r)=>s+r[1],0);
    const abroad=prefSorted.filter(p=>['中国（上海）','韓国','台湾'].includes(p[0]));
    const yearLabel=years.length===1?years[0]+'年':years.join('・')+'年';

    document.getElementById('prefSummary').style.display='block';
    document.getElementById('ps-visited').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">${yearLabel} 訪問ヵ所数</div><div style="font-size:26px;font-weight:700;color:var(--pink-dark);">${prefSorted.length}<span style="font-size:12px;font-weight:400;">ヵ所</span></div>`;
    document.getElementById('ps-events').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">総公演数</div><div style="font-size:26px;font-weight:700;color:var(--gold);">${totalEv}<span style="font-size:12px;font-weight:400;">公演</span></div>`;
    document.getElementById('ps-top').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">最多訪問地</div><div style="font-size:16px;font-weight:700;color:var(--text);">${prefSorted[0]?.[0]||'—'}</div><div style="font-size:10px;color:var(--text-muted);">${prefSorted[0]?.[1]||0}公演</div>`;
    document.getElementById('ps-abroad').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">海外公演</div><div style="font-size:16px;font-weight:700;color:var(--text);">${abroad.length}<span style="font-size:11px;font-weight:400;">ヵ国</span></div><div style="font-size:10px;color:var(--text-muted);">${abroad.map(a=>a[0]).join(' / ')||'なし'}</div>`;

    const grid=document.getElementById('prefGrid'); grid.innerHTML='';
    prefSorted.forEach(([pref,cnt])=>{
      const tops=prefTopMap[pref]||[];
      const top1=tops[0]?.[0]||'—';
      const card=document.createElement('div'); card.className='pref-card';
      card.onclick=()=>renderPrefChart(pref,tops,yearLabel);
      card.innerHTML=`<div class="pref-name">${pref}</div><div class="pref-count">${cnt}<span style="font-size:10px;font-weight:400;color:var(--text-muted);">公演</span></div><div class="pref-top">🎵 ${top1}</div>`;
      grid.appendChild(card);
    });

  } catch(e){alert('都道府県データ取得失敗: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function renderPrefChart(pref,songs,year){
  document.getElementById('prefEmptyState').style.display='none';
  document.getElementById('prefChartSub').textContent=`${pref} — ${year}年 TOP曲 (${songs.length}曲)`;
  const top20=songs.slice(0,20);
  prefChartInst=destroyChart(prefChartInst);
  prefChartInst=new Chart(resetCanvas('prefChart'),{
    type:'bar',
    data:{labels:top20.map(s=>s[0].length>12?s[0].slice(0,12)+'…':s[0]),datasets:[{label:pref,data:top20.map(s=>s[1]),backgroundColor:COLORS.map(c=>c+'bb'),borderRadius:7,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}回`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'回':''},zoom:ZoomPlugin},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10},maxRotation:35}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}}
  });
}

function resetPrefZoom(){if(prefChartInst) prefChartInst.resetZoom();}

// ============================================================
// UI
// ============================================================
let compareHasRunFlag=false;
function switchTab(id){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  ['analyze','compare','event','pref'].forEach((t,i)=>{
    if(t===id) document.querySelectorAll('.nav-btn')[i]?.classList.add('active');
  });
  document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.remove('active'));
  const mb=document.getElementById('mnav-'+id); if(mb) mb.classList.add('active');
  if(id==='compare'&&!compareHasRunFlag){compareHasRunFlag=true;runCompare();}
  if(id==='pref') loadPrefData();
  if(id==='event') initEventTab();
  if(id==='analyze') initAnalyzeTab();
}

function resetFilters(){
  document.getElementById('columnSelect').value='song';
  document.getElementById('chartTypeSelect').value='horizontalBar';
  document.getElementById('startDate').value='';
  document.getElementById('endDate').value='';
  document.getElementById('limitSelect').value='20';
  document.getElementById('statsRow').style.display='none';
  document.getElementById('emptyState').style.display='flex';
  document.getElementById('chartTitleText').textContent='分析結果';
  document.getElementById('chartSubtitle').textContent='分析設定を選択して「分析を開始する」を押してください';
  document.getElementById('rankingSection').style.display='none';
  mainChartInst=destroyChart(mainChartInst);
}

function showLoading(show){document.getElementById('loading').classList.toggle('show',show);}


// ============================================================
// 公演別分析
// ============================================================
let evAllEvents = [];      // {year, date, title, key}
let evGrouped = {};        // {year: {groupName: [events]}}
let evSelected = new Set();// 選択中の公演key Set
let evSlotA = new Set();
let evSlotB = new Set();
let evChartInst2 = null;
let evCompareChartInst = null;
let evTabInited = false;

// イベントキー生成
function evKey(year, title, date) {
  return year + '||' + date + '||' + title;
}

// タイトルからグループ名を推定（共通プレフィックス）
function inferGroup(title) {
  return title
    .replace(/[(（【〔「][^)）】〕」]*[)）】〕」]/g, '')
    .replace(/\s*(Vol\.?\d+|第\d+弾|#\d+|\d+日目|\d+公演目|PART\d+|DAY\d+|昼|夜|①②③|\d+部)\s*/gi, '')
    .replace(/\s+/g, ' ')
    .trim() || title;
}

async function initEventTab() {
  if (evTabInited) return;
  evTabInited = true;
  showLoading(true);
  try {
    evAllEvents = [];
    evGrouped = {};

    for (const yr of ALL_YEARS) {
      try {
        const rows = await fetchSheet(yr);
        const seen = new Set();
        rows.slice(2).forEach(row => {
          if (!isDataRow(row)) return;
          const title = row[C.title] || '';
          const dateRaw = row[C.date];
          if (!title.trim() || !dateRaw) return;
          const d = parseDate(dateRaw); if (!d) return;
          const ds = d.toISOString().slice(0, 10);
          const k = evKey(yr, title, ds);
          if (!seen.has(k)) {
            seen.add(k);
            const venue = String(row[C.venue]||'').trim();
            const pref = String(row[C.pref]||'').trim();
            evAllEvents.push({ year: yr, date: d, dateStr: ds, title, key: k, venue, pref });
          }
        });
      } catch(e) { /* 年データなければスキップ */ }
    }

    // 年別グループ化（同じグループ名が2公演以上のときだけグループ化）
    evAllEvents.sort((a, b) => b.date - a.date);
    evGrouped = {};
    // まず全年でグループ候補を数える（年をまたいで同名ツアーもグループ化）
    const groupCount = {};
    evAllEvents.forEach(ev => {
      const g = inferGroup(ev.title);
      // タイトルと推定グループ名が同じ（変化なし）はグループ化不要候補
      if (g !== ev.title) groupCount[g] = (groupCount[g]||0) + 1;
    });
    evAllEvents.forEach(ev => {
      if (!evGrouped[ev.year]) evGrouped[ev.year] = {};
      const g = inferGroup(ev.title);
      // 2公演以上あるグループ名だけグループ化、それ以外はタイトルをそのままグループ名に
      const groupKey = (g !== ev.title && groupCount[g] >= 2) ? g : ev.title;
      if (!evGrouped[ev.year][groupKey]) evGrouped[ev.year][groupKey] = [];
      evGrouped[ev.year][groupKey].push(ev);
    });

    renderEventList();
  } catch(e) { alert('公演データ取得失敗: ' + e.message); console.error(e); }
  finally { showLoading(false); }
}

function filterEventList() {
  renderEventList();
}

function renderEventList() {
  const query = (document.getElementById('eventSearch').value || '').toLowerCase();
  const checkedYears = new Set([...document.querySelectorAll('.ev-year-filter:checked')].map(c => c.value));
  const list = document.getElementById('eventList');
  list.innerHTML = '';

  const years = Object.keys(evGrouped).sort((a,b) => b-a);
  years.forEach(yr => {
    if (!checkedYears.has(yr)) return;
    const groups = evGrouped[yr];
    const yrSection = document.createElement('div');
    yrSection.className = 'event-year-section';

    let yrTotal = 0;
    const groupEls = [];

    Object.entries(groups).sort((a,b) => {
      // 最新公演日でソート
      const latestA = Math.max(...a[1].map(e => e.date));
      const latestB = Math.max(...b[1].map(e => e.date));
      return latestB - latestA;
    }).forEach(([groupName, events]) => {
      // クエリフィルタ
      const matched = events.filter(ev =>
        !query || ev.title.toLowerCase().includes(query) || groupName.toLowerCase().includes(query)
      );
      if (!matched.length) return;
      yrTotal += matched.length;

      const groupSec = document.createElement('div');
      groupSec.className = 'event-group-section';

      // グループヘッダー
      const gh = document.createElement('div');
      gh.className = 'event-group-header';
      const allChecked = matched.every(ev => evSelected.has(ev.key));
      const someChecked = matched.some(ev => evSelected.has(ev.key));
      gh.innerHTML = `
        <input type="checkbox" style="width:14px;height:14px;accent-color:var(--pink);flex-shrink:0;"
          ${allChecked ? 'checked' : someChecked ? 'indeterminate' : ''}
          onchange="toggleGroup(this,'${groupName}','${yr}')">
        <span class="event-group-label" title="${groupName}">${groupName}</span>
        <span class="event-group-count">${matched.length}公演</span>
        <span class="event-group-toggle">▼</span>`;
      if (someChecked && !allChecked) {
        gh.querySelector('input').indeterminate = true;
      }

      const itemsDiv = document.createElement('div');
      itemsDiv.className = 'event-items';
      // クエリあるときは自動展開
      if (query || matched.length <= 3) itemsDiv.classList.add('open');

      gh.addEventListener('click', e => {
        if (e.target.tagName === 'INPUT') return;
        itemsDiv.classList.toggle('open');
        gh.querySelector('.event-group-toggle').style.transform =
          itemsDiv.classList.contains('open') ? 'rotate(180deg)' : '';
      });

      matched.sort((a,b) => b.date - a.date).forEach(ev => {
        const item = document.createElement('div');
        item.className = 'event-item';
        const checked = evSelected.has(ev.key);
        item.innerHTML = `
          <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleEvent(this,'${ev.key}')">
          <span class="event-item-name" title="${ev.title}">${ev.title}</span>
          <span class="event-item-date">${ev.dateStr}</span>`;
        itemsDiv.appendChild(item);
      });

      groupSec.appendChild(gh);
      groupSec.appendChild(itemsDiv);
      groupEls.push(groupSec);
    });

    if (!groupEls.length) return;

    // 年ヘッダー
    const yh = document.createElement('div');
    yh.className = 'event-year-header';
    const allYrChecked = evAllEvents.filter(e=>e.year===yr).every(e=>evSelected.has(e.key));
    yh.innerHTML = `
      <input type="checkbox" style="width:14px;height:14px;accent-color:var(--pink);flex-shrink:0;"
        ${allYrChecked?'checked':''} onchange="toggleYear(this,'${yr}')">
      <span class="event-year-label">${yr}年</span>
      <span class="event-year-count">${yrTotal}公演</span>`;

    yrSection.appendChild(yh);
    groupEls.forEach(el => yrSection.appendChild(el));
    list.appendChild(yrSection);
  });

  if (!list.children.length) {
    list.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:12px;text-align:center;">該当公演なし</div>';
  }
  updateSelectedTags();
}

function toggleEvent(cb, key) {
  if (cb.checked) evSelected.add(key);
  else evSelected.delete(key);
  updateSelectedTags();
  // グループヘッダーのindeterminate更新（再描画で対応）
  renderEventList();
}

function toggleGroup(cb, groupName, yr) {
  const events = (evGrouped[yr]||{})[groupName]||[];
  events.forEach(ev => { if(cb.checked) evSelected.add(ev.key); else evSelected.delete(ev.key); });
  updateSelectedTags();
  renderEventList();
}

function toggleYear(cb, yr) {
  evAllEvents.filter(e=>e.year===yr).forEach(ev => {
    if(cb.checked) evSelected.add(ev.key); else evSelected.delete(ev.key);
  });
  updateSelectedTags();
  renderEventList();
}

function selectAllVisible() {
  const query = (document.getElementById('eventSearch').value||'').toLowerCase();
  const checkedYears = new Set([...document.querySelectorAll('.ev-year-filter:checked')].map(c=>c.value));
  evAllEvents.forEach(ev => {
    if (!checkedYears.has(ev.year)) return;
    if (query && !ev.title.toLowerCase().includes(query)) return;
    evSelected.add(ev.key);
  });
  updateSelectedTags();
  renderEventList();
}

function clearAllSelection() {
  evSelected.clear();
  updateSelectedTags();
  renderEventList();
}

function updateSelectedTags() {
  // 選択数を左パネルに表示
  const countEl = document.getElementById('evSelCount');
  if (countEl) countEl.textContent = evSelected.size ? `${evSelected.size}公演選択中` : '';

  // 公演分析パネルのタグも更新
  const container = document.getElementById('selectedTags');
  if (!container) {
    onEvSelectionChange();
    return;
  }
  container.innerHTML = '';
  if (!evSelected.size) {
    container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">公演を選択してください</span>';
    const el2 = document.getElementById('evSelCount2'); if(el2) el2.textContent = '';
    onEvSelectionChange();
    return;
  }
  const selected = evAllEvents.filter(ev => evSelected.has(ev.key)).sort((a,b)=>b.date-a.date);
  const showMax = 10;
  selected.slice(0, showMax).forEach(ev => {
    const tag = document.createElement('div'); tag.className = 'sel-tag';
    const label = ev.title.length > 16 ? ev.title.slice(0,16)+'…' : ev.title;
    tag.innerHTML = `<span>${label}</span><button class="sel-tag-x" onclick="deselectEvent('${ev.key.replace(/'/g,"\\'")}')">✕</button>`;
    container.appendChild(tag);
  });
  if (selected.length > showMax) {
    const more = document.createElement('span');
    more.style.cssText = 'font-size:11px;color:var(--text-muted);padding:3px 8px;';
    more.textContent = `…他${selected.length - showMax}公演`;
    container.appendChild(more);
  }
  const el2 = document.getElementById('evSelCount2');
  if (el2) el2.textContent = `計${selected.length}公演選択中`;
  onEvSelectionChange();
}

function deselectEvent(key) {
  evSelected.delete(key);
  updateSelectedTags();
  renderEventList();
}

// ── 分析実行 ───────────────────────────────────────────────
async function analyzeEvents() {
  if (!evSelected.size) { alert('公演を選択してください'); return; }
  openEvDrawer();
  const cat = document.getElementById('evColumnSelect').value;
  const chartType = document.getElementById('evChartTypeSelect').value;
  const limit = parseInt(document.getElementById('evLimitSelect').value);

  showLoading(true);
  try {
    const results = await buildEventResults(evSelected, cat);
    const limited = results.slice(0, limit === 999 ? results.length : limit);
    if (!limited.length) { alert('データなし'); return; }

    const selectedEvents = evAllEvents.filter(ev => evSelected.has(ev.key));
    const evTitle = summarizeEventSelection(selectedEvents);

    document.getElementById('evChartCard').style.display = 'block';
    document.getElementById('evCompareCard').style.display = 'none';
    document.getElementById('evChartTitle').textContent = evTitle;
    document.getElementById('evChartSub').textContent = `${CAT_LABEL[cat]||cat} / 上位${limited.length}曲 (${selectedEvents.length}公演のデータ)`;

    evChartInst2 = destroyChart(evChartInst2);
    const ctx = resetCanvas('evChart');
    const onClickFn = (cat !== 'combo') ? (evt, els) => {
      if (els.length > 0) {
        const name = limited[els[0].index][0];
        // 選択公演に絞ったドリルダウン
        const fakeRowsMap = buildFakeRowsMap(evSelected);
        const sd = {}; sd['vAll'] = limited[els[0].index][1]; sd.total = sd['vAll'];
        openDrillForEvents(name, fakeRowsMap, limited[els[0].index][1], selectedEvents);
      }
    } : null;
    evChartInst2 = new Chart(ctx, buildChart(chartType,
      limited.map(r => r[0]), limited.map(r => r[1]),
      CAT_LABEL[cat]||cat, onClickFn));
    if (cat !== 'combo') document.getElementById('evChart').style.cursor = 'pointer';

  } catch(e) { alert('分析失敗: ' + e.message); console.error(e); }
  finally { showLoading(false); }
}

// ── グループ比較 ───────────────────────────────────────────
async function compareSlots() {
  if (!evSlotA.size && !evSlotB.size) { alert('グループA・Bに公演を追加してください'); return; }
  if (!evSlotA.size || !evSlotB.size) { alert('グループAとBの両方に公演を追加してください'); return; }
  openEvDrawer();
  const cat = document.getElementById('evCompareCat').value;
  const limit = 30;

  showLoading(true);
  try {
    const [rA, rB] = await Promise.all([buildEventResults(evSlotA, cat), buildEventResults(evSlotB, cat)]);
    const mapA = Object.fromEntries(rA), mapB = Object.fromEntries(rB);
    const names = [...new Set([...Object.keys(mapA), ...Object.keys(mapB)])];
    const combined = names.map(n => ({ name:n, vA:mapA[n]||0, vB:mapB[n]||0, total:(mapA[n]||0)+(mapB[n]||0) }))
      .sort((a,b) => b.total - a.total).slice(0, limit===999?names.length:limit);

    const evA = evAllEvents.filter(e => evSlotA.has(e.key));
    const evB = evAllEvents.filter(e => evSlotB.has(e.key));
    const titleA = summarizeEventSelection(evA);
    const titleB = summarizeEventSelection(evB);

    document.getElementById('evCompareCard').style.display = 'block';
    document.getElementById('evCompareTitle').textContent = `${titleA} vs ${titleB}`;
    document.getElementById('evCompareSub').textContent = `${CAT_LABEL[cat]||cat} / Group A: ${evA.length}公演, Group B: ${evB.length}公演`;

    evCompareChartInst = destroyChart(evCompareChartInst);
    evCompareChartInst = new Chart(resetCanvas('evCompareChart'), {
      type: 'bar',
      data: {
        labels: combined.map(d => d.name.length > 16 ? d.name.slice(0,16)+'…' : d.name),
        datasets: [
          { label: titleA.length > 20 ? titleA.slice(0,20)+'…' : titleA, data: combined.map(d=>d.vA), backgroundColor:'rgba(244,114,182,0.85)', borderRadius:4, borderSkipped:false },
          { label: titleB.length > 20 ? titleB.slice(0,20)+'…' : titleB, data: combined.map(d=>d.vB), backgroundColor:'rgba(212,175,55,0.85)', borderRadius:4, borderSkipped:false }
        ]
      },
      options: {
        indexAxis:'y', responsive:true, maintainAspectRatio:false,
        plugins: {
          legend: { position:'top', labels:{ font:{family:'Zen Maru Gothic',size:11}, padding:12, boxWidth:10 } },
          tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.x}回` } },
          datalabels: { anchor:'end', align:'end', color:'#3d2b35', font:{family:'DM Mono',size:9,weight:'bold'}, formatter:v=>v>0?v+'回':'' },
          zoom: ZoomPluginY,
        },
        scales: {
          x: { grid:{color:'rgba(0,0,0,0.04)'}, ticks:{font:{family:'DM Mono'}} },
          y: { grid:{display:false}, ticks:{font:{family:'Zen Maru Gothic',size:11}} }
        }
      }
    });

  } catch(e) { alert('比較失敗: ' + e.message); console.error(e); }
  finally { showLoading(false); }
}

// ── スロット管理 ─────────────────────────────────────────────
function addToSlot(slot) {
  if (!evSelected.size) { alert('先に公演を選択してください'); return; }
  const target = slot === 'A' ? evSlotA : evSlotB;
  evSelected.forEach(k => target.add(k));
  renderSlot(slot);
}

function clearSlots() {
  evSlotA.clear(); evSlotB.clear();
  renderSlot('A'); renderSlot('B');
  document.getElementById('evCompareCard').style.display = 'none';
}

function renderSlot(slot) {
  const slotSet = slot === 'A' ? evSlotA : evSlotB;
  const tagsEl = document.getElementById('evTags' + slot);
  tagsEl.innerHTML = '';
  if (!slotSet.size) {
    tagsEl.innerHTML = `<span style="font-size:11px;color:var(--text-muted);">公演を選択して「${slot}に追加」</span>`;
    return;
  }
  const color = slot === 'A' ? 'var(--pink)' : 'var(--gold)';
  const bg = slot === 'A' ? 'rgba(244,114,182,0.12)' : 'rgba(212,175,55,0.12)';
  const border = slot === 'A' ? 'var(--pink)' : 'var(--gold)';
  const events = evAllEvents.filter(e => slotSet.has(e.key)).sort((a,b)=>b.date-a.date);
  // 個別公演を全て表示（スクロール可能）
  const wrap = document.createElement('div');
  wrap.style.cssText = 'display:flex;flex-direction:column;gap:3px;max-height:180px;overflow-y:auto;';
  events.forEach(ev => {
    const row = document.createElement('div');
    row.style.cssText = `display:flex;align-items:center;gap:5px;padding:4px 8px;background:${bg};border:1px solid ${border};border-radius:8px;`;
    const label = ev.title.length > 20 ? ev.title.slice(0,20)+'…' : ev.title;
    row.innerHTML = `<span style="flex:1;font-size:11px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</span>
      <span style="font-size:10px;color:var(--text-muted);flex-shrink:0;font-family:'DM Mono',monospace;">${ev.dateStr}</span>
      <button style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--text-muted);padding:0;flex-shrink:0;line-height:1;" onclick="removeFromSlot('${slot}','${ev.key.replace(/'/g,"\\'")}')">✕</button>`;
    wrap.appendChild(row);
  });
  tagsEl.appendChild(wrap);
  const cnt = document.createElement('div');
  cnt.style.cssText = 'font-size:10px;color:var(--text-muted);margin-top:4px;';
  cnt.textContent = `計 ${events.length}公演`;
  tagsEl.appendChild(cnt);
}

function removeFromSlot(slot, key) {
  if (slot === 'A') evSlotA.delete(key);
  else evSlotB.delete(key);
  renderSlot(slot);
}

// ── データ集計ヘルパー ────────────────────────────────────
async function buildEventResults(keySet, cat) {
  // keySetの公演データを全年のキャッシュから抽出して集計
  const selectedKeys = new Set(keySet);
  // 選択公演のyearリスト
  const years = [...new Set(evAllEvents.filter(e=>selectedKeys.has(e.key)).map(e=>e.year))];

  const countMap = {};
  for (const yr of years) {
    const rows = await fetchSheet(yr);
    rows.slice(2).forEach(row => {
      if (!isDataRow(row)) return;
      const d = parseDate(row[C.date]); if (!d) return;
      const ds = d.toISOString().slice(0, 10);
      const k = evKey(yr, row[C.title]||'', ds);
      if (!selectedKeys.has(k)) return;

      // 全曲集計
      if (cat === 'song' || cat === 'combo') {
        const name = row[C.rawSong]; if (!name||!name.trim()) return;
        countMap[name] = (countMap[name]||0) + 1;
      } else if (cat === 'first') {
        // 1曲目: isFirst列が★の行
        const isFirst = row[C.isFirst];
        if (!isFirst || isFirst.trim() === '') return;
        const name = row[C.rawSong]; if (!name||!name.trim()) return;
        countMap[name] = (countMap[name]||0) + 1;
      } else if (cat === 'last') {
        const isLast = row[C.isLast];
        if (!isLast || isLast.trim() === '') return;
        const name = row[C.rawSong]; if (!name||!name.trim()) return;
        countMap[name] = (countMap[name]||0) + 1;
      }
    });
  }
  return Object.entries(countMap).sort((a,b)=>b[1]-a[1]);
}

function summarizeEventSelection(events) {
  if (!events.length) return '（未選択）';
  if (events.length === 1) return events[0].title;
  // 最も多いグループ名を代表に
  const groups = {};
  events.forEach(ev => { const g=inferGroup(ev.title); groups[g]=(groups[g]||0)+1; });
  const top = Object.entries(groups).sort((a,b)=>b[1]-a[1])[0];
  if (top[1] === events.length) return top[0];
  if (top[1] > 1) return `${top[0]} 他`;
  return `${events.length}公演`;
}

// 公演別ドリルダウン（選択公演に絞って月別表示）
function openDrillForEvents(songName, rowsMap, total, selectedEvents) {
  // 日付→月のマッピング
  const monthly = {}; for(let m=1;m<=12;m++) monthly[m]=0;
  const evList = [];
  selectedEvents.forEach(ev => {
    const rows = sheetCache[ev.year] || [];
    rows.slice(2).forEach(row => {
      if (!isDataRow(row)) return;
      if (row[C.rawSong] !== songName) return;
      const d = parseDate(row[C.date]); if (!d) return;
      const ds = d.toISOString().slice(0,10);
      const k = evKey(ev.year, row[C.title]||'', ds);
      if (!evSelected.has(k) && !evSlotA.has(k) && !evSlotB.has(k)) return;
      monthly[d.getMonth()+1]++;
      evList.push({ date:d, title:row[C.title]||'不明', venue:row[C.venue]||'', pref:row[C.pref]||'', year:ev.year });
    });
  });
  evList.sort((a,b)=>b.date-a.date);

  // openDrillMultiの代わりに直接モーダル描画
  document.getElementById('drillSongName').textContent = songName;
  document.getElementById('drillSongSub').textContent = `選択公演内 合計: ${total}回`;
  const yrGrid = document.getElementById('drillYearGrid');
  yrGrid.innerHTML = `<div class="stat-badge"><div style="font-size:10px;color:var(--text-muted);margin-bottom:3px;">選択公演内</div><div style="font-size:28px;font-weight:700;color:var(--pink);">${total}回</div></div>`;

  drillInst = destroyChart(drillInst);
  const mths=['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
  drillInst = new Chart(resetCanvas('drillMonthChart'), {
    type:'bar',
    data:{labels:mths,datasets:[{label:'歌唱回数',data:mths.map((_,i)=>monthly[i+1]),backgroundColor:'rgba(244,114,182,0.8)',borderRadius:5}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}回`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:9,weight:'bold'},formatter:v=>v>0?v+'回':''}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}}
  });

  const evHtml = evList.slice(0,20).map(e => {
    const ds=`${e.date.getFullYear()}/${String(e.date.getMonth()+1).padStart(2,'0')}/${String(e.date.getDate()).padStart(2,'0')}`;
    const yc=YEAR_COLORS[e.year]||{border:'#888'};
    return `<div style="display:flex;gap:7px;align-items:flex-start;padding:6px 10px;background:var(--bg);border-radius:9px;">
      <span style="font-size:9px;font-weight:700;color:#fff;background:${yc.border};padding:2px 6px;border-radius:20px;flex-shrink:0;margin-top:2px;">${e.year}</span>
      <div style="flex:1;overflow:hidden;"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.title}</div>
      <div style="font-size:10px;color:var(--text-muted);">${ds}${e.venue?' · '+e.venue:''}${e.pref?' 📍'+e.pref:''}</div></div></div>`;
  }).join('');
  document.getElementById('drillEventList').innerHTML = evHtml || '<div style="color:var(--text-muted);font-size:13px;">イベント情報なし</div>';
  document.getElementById('drillModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function buildFakeRowsMap(keySet) {
  const years = [...new Set(evAllEvents.filter(e=>keySet.has(e.key)).map(e=>e.year))];
  const m = {};
  years.forEach(yr => { if(sheetCache[yr]) m[yr] = sheetCache[yr]; });
  return m;
}

function resetEvZoom() { if(evChartInst2) evChartInst2.resetZoom(); }

function resetEventPanel() {
  closeEvDrawer();
  // 選択解除
  evSelected.clear();
  renderEventList();
  // セトリパネルをリセット
  const setlistDisplay = document.getElementById('setlistDisplay');
  const setlistEmpty = document.getElementById('setlistEmpty');
  if (setlistDisplay) setlistDisplay.style.display = 'none';
  if (setlistEmpty) {
    setlistEmpty.style.display = '';
    setlistEmpty.innerHTML = '<div style="font-size:32px;margin-bottom:8px;">🎵</div>公演を1つ選択してください';
  }
  // 分析チャートをリセット
  const evChartCard = document.getElementById('evChartCard');
  if (evChartCard) evChartCard.style.display = 'none';
  evChartInst2 = destroyChart(evChartInst2);
  // グループ比較もリセット
  clearSlots();
}
function resetEvCompareZoom() { if(evCompareChartInst) evCompareChartInst.resetZoom(); }

// モバイル対応：グリッドをスタック
function applyEventGridLayout() {
  const grid = document.getElementById('evMainGrid');
  if (!grid) return;
  grid.style.gridTemplateColumns = window.innerWidth <= 900 ? '1fr' : '320px 1fr';
}
window.addEventListener('resize', applyEventGridLayout);
applyEventGridLayout();


// ============================================================
// 楽曲分析タブ — モード管理
// ============================================================
let currentAnalyzeMode = 'category';
let allSongNames = [];  // 全年から収集した楽曲名リスト
let songChartTrend = null, songChartMonth = null;

function setAnalyzeMode(mode) {
  currentAnalyzeMode = mode;
  document.getElementById('panelCategory').style.display = mode==='category' ? '' : 'none';
  document.getElementById('panelSong').style.display = mode==='song' ? '' : 'none';
  document.getElementById('modeBtnCategory').classList.toggle('active', mode==='category');
  document.getElementById('modeBtnSong').classList.toggle('active', mode==='song');
  // 結果リセット
  document.getElementById('mainChartCard').style.display = mode==='category' ? '' : 'none';
  document.getElementById('statsRow').style.display = 'none';
  document.getElementById('rankingSection').style.display = 'none';
  document.getElementById('songAnalysisPanel').style.display = mode==='song' ? '' : 'none';
  if(mode==='song') loadSongNameList();
}

function initAnalyzeTab() {
  // Already initialized on page load, nothing to do
}

function onAnalyzeYearChange() {
  // 年変更時に楽曲名リストをリセット
  allSongNames = [];
  if(currentAnalyzeMode === 'song') loadSongNameList();
}

async function loadSongNameList() {
  const years = [...document.querySelectorAll('.an-year-cb:checked')].map(cb=>cb.value);
  if(!years.length) return;
  const nameSet = new Set();
  showLoading(true);
  try {
    for(const yr of years) {
      const rows = await fetchSheet(yr);
      rows.slice(2).forEach(row => {
        if(!isDataRow(row)) return;
        const n = row[C.rawSong]; if(n && n.trim()) nameSet.add(n.trim());
      });
    }
    allSongNames = [...nameSet].sort();
    // datalist更新
    const dl = document.getElementById('songDatalist');
    dl.innerHTML = allSongNames.map(n=>`<option value="${n.replace(/"/g,'&quot;')}">`).join('');
    // クイックピック（よく歌われる上位5曲をサジェスト）
    renderSongQuickPicks(allSongNames.slice(0, 20));
  } catch(e) { console.error(e); }
  finally { showLoading(false); }
}

function renderSongQuickPicks(names) {
  const qp = document.getElementById('songQuickPicks');
  qp.innerHTML = '<span style="font-size:10px;color:var(--text-muted);align-self:center;flex-shrink:0;">候補：</span>' +
    names.slice(0,8).map(n=>
      `<button class="btn" style="padding:4px 10px;font-size:11px;background:var(--pink-light);color:var(--pink-dark);border-radius:20px;"
        onclick="document.getElementById('songSearchInput').value='${n.replace(/'/g,"\\'")}';analyzeSong()">${n}</button>`
    ).join('');
}

function onSongInputChange() {
  // 入力に合わせてクイックピックをフィルタ
  const q = document.getElementById('songSearchInput').value.toLowerCase();
  if(!q) { renderSongQuickPicks(allSongNames.slice(0,8)); return; }
  const filtered = allSongNames.filter(n => n.toLowerCase().includes(q));
  renderSongQuickPicks(filtered.slice(0,8));
}

async function analyzeSong() {
  const songName = document.getElementById('songSearchInput').value.trim();
  if(!songName) { showToast && showToast('曲名を入力してください'); alert('曲名を入力してください'); return; }
  const years = [...document.querySelectorAll('.an-year-cb:checked')].map(cb=>cb.value);
  if(!years.length) { alert('対象年を1つ以上選択してください'); return; }

  showLoading(true);
  try {
    const rowsMap = {};
    for(const yr of years) { rowsMap[yr] = await fetchSheet(yr); }

    // 年別カウント
    const yearCounts = {};
    const monthlyAll = {}; for(let m=1;m<=12;m++) monthlyAll[m]=0;
    const allEvents = [];

    for(const yr of years) {
      let cnt = 0;
      const monthly = {}; for(let m=1;m<=12;m++) monthly[m]=0;
      const seen = new Set();
      rowsMap[yr].slice(2).forEach(row => {
        if(!isDataRow(row)) return;
        if(row[C.rawSong] !== songName) return;
        const d = parseDate(row[C.date]); if(!d) return;
        cnt++;
        monthly[d.getMonth()+1]++;
        monthlyAll[d.getMonth()+1]++;
        const key = row[C.date]+'_'+(row[C.title]||'');
        if(!seen.has(key)){
          seen.add(key);
          allEvents.push({date:d, title:row[C.title]||'不明', venue:row[C.venue]||'', pref:row[C.pref]||'', year:yr, isFirst:!!row[C.isFirst]?.trim(), isLast:!!row[C.isLast]?.trim()});
        }
      });
      yearCounts[yr] = cnt;
    }

    const totalCount = Object.values(yearCounts).reduce((a,b)=>a+b, 0);
    if(!totalCount) { alert(`「${songName}」のデータが見つかりませんでした`); return; }

    allEvents.sort((a,b) => b.date - a.date);
    const lastEvent = allEvents[0];
    const firstEvent = allEvents[allEvents.length-1];
    const firstCount = allEvents.filter(e=>e.isFirst).length;
    const lastCount = allEvents.filter(e=>e.isLast).length;

    // サマリーカード
    const sgrid = document.getElementById('songSummaryGrid');
    const lastDs = lastEvent ? `${lastEvent.date.getFullYear()}/${String(lastEvent.date.getMonth()+1).padStart(2,'0')}/${String(lastEvent.date.getDate()).padStart(2,'0')}` : '—';
    const firstDs = firstEvent ? `${firstEvent.date.getFullYear()}/${String(firstEvent.date.getMonth()+1).padStart(2,'0')}/${String(firstEvent.date.getDate()).padStart(2,'0')}` : '—';
    sgrid.innerHTML = `
      <div class="song-sum-card"><div class="song-sum-label">総歌唱回数</div><div class="song-sum-val">${totalCount}回</div><div class="song-sum-sub">${years.join('・')}年合計</div></div>
      <div class="song-sum-card"><div class="song-sum-label">最終歌唱日</div><div class="song-sum-val" style="font-size:15px;">${lastDs}</div><div class="song-sum-sub">${lastEvent?.title||'—'}</div></div>
      <div class="song-sum-card"><div class="song-sum-label">初歌唱日</div><div class="song-sum-val" style="font-size:15px;">${firstDs}</div><div class="song-sum-sub">${firstEvent?.title||'—'}</div></div>
      <div class="song-sum-card"><div class="song-sum-label">1曲目起用</div><div class="song-sum-val">${firstCount}回</div><div class="song-sum-sub">トリ起用: ${lastCount}回</div></div>
    `;

    // 年別推移グラフ
    document.getElementById('songTrendTitle').textContent = `「${songName}」年別 歌唱回数`;
    document.getElementById('songTrendSub').textContent = `全${years.length}年間の推移`;
    songChartTrend = destroyChart(songChartTrend);
    songChartTrend = new Chart(resetCanvas('songTrendChart'), {
      type:'bar',
      data:{
        labels: years.map(yr=>yr+'年'),
        datasets:[{
          label:'歌唱回数', data:years.map(yr=>yearCounts[yr]||0),
          backgroundColor: years.map(yr=>(YEAR_COLORS[yr]||{bg:'#f472b6'}).bg),
          borderRadius:8, borderSkipped:false
        }]
      },
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},
          tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}回`}},
          datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:12,weight:'bold'},formatter:v=>v>0?v+'回':''}
        },
        scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:12}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}
      }
    });

    // 月別分布グラフ
    const mths=['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
    document.getElementById('songMonthSub').textContent = `全年合計 / 月別分布`;
    songChartMonth = destroyChart(songChartMonth);
    songChartMonth = new Chart(resetCanvas('songMonthChart'), {
      type:'bar',
      data:{labels:mths,datasets:[{label:'歌唱回数',data:mths.map((_,i)=>monthlyAll[i+1]),backgroundColor:'rgba(244,114,182,0.8)',borderRadius:6,borderSkipped:false}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}回`}},
          datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'回':''}
        },
        scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}
      }
    });

    // イベント一覧
    document.getElementById('songEventListTitle').textContent = `📋 出演イベント一覧（${allEvents.length}件）`;
    document.getElementById('songEventList').innerHTML = allEvents.slice(0,30).map(e => {
      const ds = `${e.date.getFullYear()}/${String(e.date.getMonth()+1).padStart(2,'0')}/${String(e.date.getDate()).padStart(2,'0')}`;
      const yc = YEAR_COLORS[e.year]||{border:'#888'};
      return `<div style="display:flex;gap:7px;align-items:flex-start;padding:6px 10px;background:var(--bg);border-radius:9px;">
        <span style="font-size:9px;font-weight:700;color:#fff;background:${yc.border};padding:2px 6px;border-radius:20px;flex-shrink:0;margin-top:2px;">${e.year}</span>
        <div style="flex:1;overflow:hidden;">
          <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.title}</div>
          <div style="font-size:10px;color:var(--text-muted);">${ds}${e.venue?' · '+e.venue:''}${e.pref?' 📍'+e.pref:''}</div>
        </div>
        ${e.isFirst ? '<span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;background:var(--gold-light);color:var(--gold);flex-shrink:0;">1曲目</span>' : ''}
        ${e.isLast ? '<span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;background:var(--pink-light);color:var(--pink-dark);flex-shrink:0;">トリ</span>' : ''}
      </div>`;
    }).join('') || '<div style="color:var(--text-muted);font-size:13px;padding:12px;">データなし</div>';

    document.getElementById('songAnalysisPanel').style.display = '';
    document.getElementById('mainChartCard').style.display = 'none';

  } catch(e) { alert('分析失敗: '+e.message); console.error(e); }
  finally { showLoading(false); }
}

function clearSongAnalysis() {
  document.getElementById('songSearchInput').value = '';
  document.getElementById('songAnalysisPanel').style.display = 'none';
  songChartTrend = destroyChart(songChartTrend);
  songChartMonth = destroyChart(songChartMonth);
}

// ============================================================
// 公演別タブ — モード管理
// ============================================================
let currentEventMode = 'setlist';

function setEventMode(mode) {
  closeEvDrawer();
  currentEventMode = mode;
  ['setlist','analyze','compare'].forEach(m => {
    document.getElementById('evModeBtn'+m.charAt(0).toUpperCase()+m.slice(1)).classList.toggle('active', m===mode);
    document.getElementById('evPanel'+m.charAt(0).toUpperCase()+m.slice(1)).style.display = m===mode ? '' : 'none';
  });
  const descs = {setlist:'公演を選んでセトリを確認します', analyze:'選択した公演の楽曲傾向を分析します', compare:'2グループに分けて楽曲傾向を比較します'};
  document.getElementById('evModeDesc').textContent = descs[mode];
}

// セトリ表示（1公演選択時に自動表示）
async function showSetlist(evKey_) {
  const ev = evAllEvents.find(e => e.key === evKey_);
  if(!ev) return;
  showLoading(true);
  try {
    // 年別シートから直接セトリ取得（通常曲＋アンコール）
    const yearRows = await fetchYearSheet(ev.year);
    let normalSongs = [], encoreSongs = [], venue = ev.venue || '', pref = ev.pref || '';

    if(yearRows) {
      yearRows.slice(2).forEach(row => {
        const d = parseDate(row[YC2.dateCalc]); if(!d) return;
        const ds = d.toISOString().slice(0,10);
        const title = String(row[YC2.title]||'').trim();
        const k = evKey(ev.year, title, ds);
        if(k !== evKey_) return;
        // 通常セトリ
        const setStr = String(row[YC2.setlist]||'').trim();
        if(setStr) normalSongs = setStr.split(',').map(s=>s.trim()).filter(Boolean);
        // アンコール
        const encStr = String(row[YC2.encore]||'').trim();
        if(encStr) encoreSongs = encStr.split(',').map(s=>s.trim()).filter(Boolean);
        // 会場
        if(!venue && row[YC2.venue]) venue = String(row[YC2.venue]).trim();
        if(!pref && row[YC2.pref]) pref = String(row[YC2.pref]).trim();
      });
    }

    // 年別シートで取得できない場合は楽曲分解シートにフォールバック
    if(!normalSongs.length) {
      const rows = await fetchSheet(ev.year);
      rows.slice(2).forEach(row => {
        if(!isDataRow(row)) return;
        const d = parseDate(row[C.date]); if(!d) return;
        const ds = d.toISOString().slice(0,10);
        const k = evKey(ev.year, row[C.title]||'', ds);
        if(k !== evKey_) return;
        if(!row[C.rawSong]?.trim()) return;
        if(row[C.isFirst]?.trim() || row[C.isLast]?.trim() ||
           normalSongs.includes(row[C.rawSong].trim()) === false) {
          normalSongs.push(row[C.rawSong].trim());
        }
      });
    }

    document.getElementById('setlistEmpty').style.display = 'none';
    document.getElementById('setlistDisplay').style.display = '';
    document.getElementById('setlistTitle').textContent = ev.title;
    document.getElementById('setlistMeta').textContent = `${ev.dateStr}${venue ? ' · '+venue : ''}${pref ? ' 📍'+pref : ''}`;

    // 通常曲とアンコール曲を区別表示
    if(normalSongs.length || encoreSongs.length) {
      let html = normalSongs.map((name,i) => {
        const isFirst = i === 0;
        const isLast = i === normalSongs.length - 1;
        return `<div class="setlist-song ${isFirst?'is-first':''} ${isLast?'is-last':''}">
          <span class="setlist-num">${i+1}</span>
          <span class="setlist-name">${name}</span>
          ${isFirst ? '<span class="setlist-tag first">1曲目</span>' : ''}
          ${isLast ? '<span class="setlist-tag last">トリ</span>' : ''}
        </div>`;
      }).join('');
      if(encoreSongs.length) {
        html += `<div style="font-size:10px;font-weight:700;color:var(--pink-dark);margin:10px 0 4px;padding-left:4px;letter-spacing:1px;">🎶 ENCORE</div>`;
        html += encoreSongs.map((name,i) => `
          <div class="setlist-song" style="border-left-color:#f0abfc;background:rgba(240,171,252,0.08);">
            <span class="setlist-num">EN${i+1}</span>
            <span class="setlist-name">${name}</span>
            <span class="setlist-tag" style="background:rgba(240,171,252,0.2);color:#a21caf;">アンコール</span>
          </div>`).join('');
      }
      document.getElementById('setlistSongs').innerHTML = html;
    } else {
      document.getElementById('setlistSongs').innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">セトリデータが見つかりませんでした</div>';
    }
  } catch(e) { console.error(e); }
  finally { showLoading(false); }
}

// モバイル：ドロワー開閉
function openEvDrawer() {
  if(window.innerWidth > 768) return;
  document.getElementById('evRightPanel').classList.add('drawer-open');
  document.getElementById('evDrawerOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}
function closeEvDrawer() {
  document.getElementById('evRightPanel').classList.remove('drawer-open');
  document.getElementById('evDrawerOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

// 公演選択時にセトリを自動表示（セトリモード限定）
function onEvSelectionChange() {
  if(currentEventMode === 'setlist' && evSelected.size === 1) {
    showSetlist([...evSelected][0]);
    openEvDrawer();  // モバイルでドロワーを開く
  } else if(currentEventMode === 'setlist' && evSelected.size !== 1) {
    document.getElementById('setlistDisplay').style.display = 'none';
    document.getElementById('setlistEmpty').style.display = '';
    document.getElementById('setlistEmpty').innerHTML = evSelected.size === 0
      ? '<div style="font-size:32px;margin-bottom:8px;">🎵</div>公演を1つ選択してください'
      : `<div style="font-size:32px;margin-bottom:8px;">🎵</div>${evSelected.size}件選択中。セトリ確認は1件ずつ選択してください`;
  }
}

// モーダル外クリックで閉じる
document.getElementById('drillModal').addEventListener('click',e=>{if(e.target===document.getElementById('drillModal')) closeDrill();});
</script>
</body>
</html>
